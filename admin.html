<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yemekhane Yönetimi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="icon" type="image/jpeg" href="Admin.jpg">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            /* KURUMSAL RENK PALETİ (Ice Blue & Slate) */
            --bg-body: #e3e8ef; --bg-sidebar: #ffffff; --bg-card: #ffffff;          
            --text-main: #1e293b; --text-muted: #64748b;       
            --primary: #2563eb; --primary-hover: #1d4ed8; --primary-light: #eff6ff;    
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --border-color: #e2e8f0; --border-radius: 16px;       
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
        
        /* MOBİL İÇİN ÖZEL ÜST BAR (Sadece mobilde görünür) */
        .mobile-header {
            display: none; /* Masaüstünde gizli */
            background: var(--bg-card); padding: 15px; 
            box-shadow: var(--shadow-sm); align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1040;
        }
        .mobile-logo { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid var(--border-color); }

        /* GİRİŞ EKRANI */
        #loginSection { background: var(--bg-body); background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 24px 24px; }
        .login-card { background: var(--bg-card); border-radius: var(--border-radius); padding: 40px; width: 100%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: var(--shadow-card); }

        /* SIDEBAR (Masaüstü & Mobil Offcanvas) */
        .sidebar { background-color: var(--bg-sidebar); height: 100vh; border-right: 1px solid var(--border-color); overflow-y: auto; }
        .sidebar-logo { width: 90px; height: 90px; object-fit: cover; border-radius: 50%; border: 4px solid var(--bg-body); margin-bottom: 15px; box-shadow: var(--shadow-sm); }
        
        .nav-link { color: var(--text-muted); margin-bottom: 5px; border-radius: 10px; padding: 12px 20px; font-weight: 600; transition: all 0.2s ease; cursor: pointer; }
        .nav-link:hover { background-color: var(--bg-body); color: var(--primary); transform: translateX(3px); }
        .nav-link.active { background-color: var(--primary-light); color: var(--primary); border-right: 4px solid var(--primary); }
        .nav-link i { width: 24px; text-align: center; margin-right: 10px; }

        /* KARTLAR */
        .admin-card { background: var(--bg-card); border-radius: var(--border-radius); box-shadow: var(--shadow-card); padding: 20px; margin-bottom: 20px; border: 1px solid #fff; }
        
        /* İstatistik Kartları Mobilde 2'li sığsın diye font ayarı */
        .stat-card { border-top: 4px solid transparent; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; color: var(--text-muted); }
        .stat-val { font-size: 2rem; font-weight: 800; margin-top: 5px; line-height: 1; color: var(--text-main); }

        /* FORM & TABLO */
        .form-control { background-color: #f8fafc; border: 1px solid #cbd5e1; padding: 12px; border-radius: 10px; }
        .form-control:focus { background-color: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        .table thead th { background-color: #f8fafc; color: var(--text-muted); font-size: 0.75rem; padding: 12px; }
        .table tbody td { padding: 12px; vertical-align: middle; font-size: 0.9rem; }
        .sortable-th { cursor: pointer; user-select: none; }

        /* RESPONSIVE AYARLAR */
        @media (max-width: 768px) {
            .mobile-header { display: flex; } /* Mobilde üst barı aç */
            .sidebar { display: none; } /* Mobilde normal sidebarı gizle */
            
            /* Offcanvas Sidebar Ayarları */
            .offcanvas-start { width: 280px !important; border-right: 1px solid var(--border-color); }
            
            main { padding-top: 20px !important; }
            .stat-val { font-size: 1.8rem; } /* Teleforda sayılar taşmasın */
            
            /* Tablolarda yatay kaydırma */
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }

        /* DİĞER */
        .feed-row { padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; }
        .feed-row:nth-child(even) { background-color: #f8fafc; }
        .badge-soft-success { background-color: #d1fae5; color: #065f46; }
        .badge-soft-danger { background-color: #fee2e2; color: #991b1b; }
        
        #printArea { display: none; }
        @media print {
            body * { visibility: hidden; } #dashboardSection, .sidebar, .mobile-header { display: none !important; }
            #printArea { display: flex !important; visibility: visible !important; position: absolute; left: 0; top: 0; width: 100%; flex-wrap: wrap; background: white; z-index: 99999; }
            #printArea * { visibility: visible !important; color: black !important; }
            .col-print { width: 30%; float: left; margin: 1.5%; border: 1px solid #000; padding: 10px; text-align: center; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div id="loginSection" class="d-flex justify-content-center align-items-center vh-100">
    <div class="login-card text-center mx-3">
        <img src="logo.jpg" alt="Logo" class="sidebar-logo shadow-sm">
        <h4 class="fw-bold mb-1 text-dark">YÖNETİCİ GİRİŞİ</h4>
        <p class="text-muted small mb-4">Güvenli Yönetim Paneli</p>
        <input type="email" id="email" class="form-control mb-3" placeholder="E-Posta Adresi">
        <input type="password" id="password" class="form-control mb-4" placeholder="Şifre">
        <button onclick="window.login()" class="btn btn-primary w-100 py-3 fw-bold" style="background:var(--primary);">GÜVENLİ GİRİŞ</button>
    </div>
</div>

<div class="mobile-header" id="mobileHeader">
    <div class="d-flex align-items-center">
        <img src="logo.jpg" class="mobile-logo me-2">
        <span class="fw-bold text-dark">YEMEKHANE</span>
    </div>
    <button class="btn btn-light text-primary border" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
        <i class="fas fa-bars fa-lg"></i>
    </button>
</div>

<div id="dashboardSection" class="container-fluid d-none">
    <div class="row">
        
        <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar p-3 text-center text-md-start position-fixed">
            <div class="text-center py-4 border-bottom mb-3" style="border-color: #f1f5f9 !important;">
                <img src="logo.jpg" alt="Logo" class="sidebar-logo">
                <h6 class="fw-bold text-dark mb-0 mt-2" style="letter-spacing: 1px;">YEMEKHANE</h6>
                <small class="text-muted" style="font-size: 0.7rem;">YÖNETİM PANELİ</small>
            </div>
            <div class="menu-items">
                <a class="nav-link active" onclick="showTab('main', this)"><i class="fas fa-chart-line"></i> Genel Bakış</a>
                <a class="nav-link" onclick="showTab('students', this); loadStudents();"><i class="fas fa-user-graduate"></i> Öğrenci İşlemleri</a>
                <a class="nav-link" onclick="showTab('codes', this); loadVeliCodes();"><i class="fas fa-qrcode"></i> Erişim Kodları</a>
                <a class="nav-link" onclick="showTab('users', this); listScannerUsers();"><i class="fas fa-users-cog"></i> Personel Yönetimi</a>
            </div>
            <div class="mt-auto pt-5 pb-3 text-center position-absolute bottom-0 w-100 start-0 px-3">
                <a class="nav-link text-danger fw-bold bg-light" onclick="window.logout()" style="border: 1px solid #fee2e2;"><i class="fas fa-sign-out-alt"></i> ÇIKIŞ</a>
            </div>
        </nav>

        <div class="offcanvas offcanvas-start bg-white" tabindex="-1" id="mobileMenu">
            <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title fw-bold text-primary"><img src="logo.jpg" width="30" class="me-2 rounded-circle"> MENÜ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
            </div>
            <div class="offcanvas-body p-3 d-flex flex-column">
                <div class="menu-items">
                    <a class="nav-link active mb-2" onclick="showTab('main', this); closeCanvas()"><i class="fas fa-chart-line"></i> Genel Bakış</a>
                    <a class="nav-link mb-2" onclick="showTab('students', this); loadStudents(); closeCanvas()"><i class="fas fa-user-graduate"></i> Öğrenci İşlemleri</a>
                    <a class="nav-link mb-2" onclick="showTab('codes', this); loadVeliCodes(); closeCanvas()"><i class="fas fa-qrcode"></i> Erişim Kodları</a>
                    <a class="nav-link mb-2" onclick="showTab('users', this); listScannerUsers(); closeCanvas()"><i class="fas fa-users-cog"></i> Personel Yönetimi</a>
                </div>
                <div class="mt-auto">
                    <a class="btn btn-danger w-100 fw-bold" onclick="window.logout()"><i class="fas fa-sign-out-alt me-2"></i> ÇIKIŞ YAP</a>
                </div>
            </div>
        </div>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            
            <div id="tab-main" class="tab-content">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <div>
                        <h4 class="fw-bold text-dark mb-0">Genel Durum</h4>
                        <p class="text-muted small mb-0 d-none d-md-block">Günlük istatistikler.</p>
                    </div>
                    <div class="bg-white px-3 py-2 rounded-pill shadow-sm fw-bold text-primary border small">
                        <i class="far fa-calendar-alt me-2"></i><span id="bugunTarih"></span>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="admin-card stat-card h-100 p-3" style="border-top-color: var(--success);">
                            <div class="stat-label" style="color: var(--success);">BUGÜN YİYEN</div>
                            <div class="stat-val text-dark" id="lblBugunYiyen">0</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="admin-card stat-card h-100 p-3" style="border-top-color: var(--danger);">
                            <div class="stat-label text-danger">ÇİFT DİKİŞ</div>
                            <div class="stat-val text-dark" id="lblCiftDikis">0</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="admin-card stat-card h-100 p-3" style="border-top-color: var(--warning);">
                            <div class="stat-label" style="color: var(--warning);">KALAN</div>
                            <div class="stat-val text-dark" id="lblYemeyen">0</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="admin-card h-100 d-flex align-items-center justify-content-center p-1">
                            <canvas id="yemekPieChart" style="max-height: 90px;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="admin-card p-0 overflow-hidden" style="height: 500px; display: flex; flex-direction: column;">
                            <div class="p-3 border-bottom bg-white sticky-top"><h6 class="fw-bold mb-0 text-dark">Canlı Akış</h6></div>
                            <div id="akisListesi" style="overflow-y: auto; flex: 1;"></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="admin-card">
                            <h6 class="fw-bold mb-3 pb-2 border-bottom text-dark">Eksik Listesi</h6>
                            <button class="btn btn-warning w-100 fw-bold d-flex justify-content-between align-items-center text-white mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseYemeyenler">
                                <span><i class="fas fa-list-ul me-2"></i>Listeyi Aç</span> <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="collapse show" id="collapseYemeyenler">
                                <div id="yemeyenlerListesi" style="max-height: 350px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div class="text-center text-muted small py-3">Yükleniyor...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-students" class="tab-content d-none">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h4 class="fw-bold text-dark mb-0">Öğrenci Yönetimi</h4>
                    <div class="d-flex gap-2">
                        <button onclick="openStudentModal('add')" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Ekle</button>
                        <button onclick="bulkDelete()" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i> Sil</button>
                    </div>
                </div>
                
                <div class="admin-card p-3">
                    <div class="row mb-3 g-2">
                        <div class="col-md-8">
                            <input type="text" id="studentSearch" class="form-control" placeholder="Öğrenci Ara..." onkeyup="filterStudents()">
                        </div>
                        <div class="col-md-4">
                            <input type="file" id="excelDosyasi" class="form-control" accept=".xlsx" onchange="excelYukle()">
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="30"><input type="checkbox" id="selectAll" class="form-check-input" onclick="toggleSelectAll()"></th>
                                    <th class="sortable-th" onclick="sortStudents('numara')">No</th>
                                    <th class="sortable-th" onclick="sortStudents('ad_soyad')">Ad Soyad</th>
                                    <th class="sortable-th" onclick="sortStudents('sinif')">Sınıf</th>
                                    <th class="d-none d-md-table-cell">Barkod</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody id="studentListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-codes" class="tab-content d-none">
                <h4 class="fw-bold text-dark mb-3">Erişim Kodları</h4>
                <div class="admin-card mb-3 p-3">
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button onclick="generateMissingCodes()" class="btn btn-primary btn-sm flex-fill">Tamamla</button>
                        <button onclick="regenerateAllCodes()" class="btn btn-warning btn-sm text-white flex-fill">Yenile</button>
                        <button onclick="deleteAllCodes()" class="btn btn-danger btn-sm flex-fill">Sil</button>
                        <button onclick="window.print()" class="btn btn-secondary btn-sm ms-auto"><i class="fas fa-print"></i></button>
                    </div>
                    <input type="text" id="codeSearch" class="form-control" placeholder="Öğrenci Ara..." onkeyup="filterCodes()">
                </div>
                <div class="admin-card p-0" id="code-list" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead><tr><th>No</th><th>Öğrenci</th><th>Kod</th><th>Durum</th><th>Sil</th></tr></thead>
                        <tbody id="codeListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-users" class="tab-content d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold text-dark">Personel</h4>
                    <button onclick="openScannerModal('add')" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Yeni</button>
                </div>
                <div class="row g-3">
                    <div class="col-lg-8">
                        <div class="admin-card p-0">
                            <div class="p-3 border-bottom bg-light"><h6 class="fw-bold mb-0 text-primary">Personel Listesi</h6></div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead><tr><th>İsim</th><th>E-Posta</th><th>Rol</th><th>İşlem</th></tr></thead>
                                    <tbody id="scannerListBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="admin-card border-warning" style="border-left: 5px solid var(--warning);">
                            <h6 class="fw-bold text-warning mb-3">Admin Şifre Değiştir</h6>
                            <input type="text" id="newAdminPass" class="form-control mb-2" placeholder="Yeni Şifre">
                            <button onclick="changeAdminPass()" class="btn btn-warning w-100 text-white fw-bold">Güncelle</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="printArea"></div>

<div class="modal fade" id="studentModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold" id="modalTitle">Öğrenci İşlemi</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><input type="hidden" id="editOldBarkod"><div class="mb-3"><label class="form-label fw-bold small text-muted">Ad Soyad</label><input type="text" id="editAd" class="form-control"></div><div class="row g-2 mb-3"><div class="col-6"><label class="form-label fw-bold small text-muted">Numara</label><input type="text" id="editNo" class="form-control"></div><div class="col-6"><label class="form-label fw-bold small text-muted">Sınıf</label><input type="text" id="editSinif" class="form-control"></div></div><div class="mb-3"><label class="form-label fw-bold small text-muted">Barkod</label><input type="text" id="editBarkodInput" class="form-control" placeholder="Otomatik Üret"></div></div><div class="modal-footer bg-light"><button onclick="saveStudent()" class="btn btn-primary w-100">Kaydet</button></div></div></div></div>
<div class="modal fade" id="scannerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-success text-white"><h5 class="modal-title fw-bold" id="scannerModalTitle">Personel İşlemi</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><input type="hidden" id="editScannerId"><div class="mb-3"><label class="form-label fw-bold small text-muted">Görevli İsmi</label><input type="text" id="scName" class="form-control"></div><div class="mb-3"><label class="form-label fw-bold small text-muted">E-Posta</label><input type="email" id="scEmail" class="form-control"></div><div class="mb-3"><label class="form-label fw-bold small text-muted">Şifre</label><input type="text" id="scPass" class="form-control"></div></div><div class="modal-footer bg-light"><button onclick="saveScannerUser()" class="btn btn-success w-100">Kaydet</button></div></div></div></div>
<div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-warning text-white"><h5 class="modal-title fw-bold">Geçmiş</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="p-3 bg-light border-bottom"><h5 id="histName" class="m-0 fw-bold text-dark"></h5></div><ul id="historyList" class="list-group list-group-flush" style="max-height:300px;overflow-y:auto;"></ul></div></div></div></div>

<script type="module">
    // Firebase ve Core JS kodları AYNEN KORUNMUŞTUR
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, updatePassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, getDocs, orderBy, deleteDoc, limit, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyC2ATSLTN8ba3pao1kKd2cT1vHcT8rafT8", authDomain: "yemekhane-8914d.firebaseapp.com", projectId: "yemekhane-8914d", storageBucket: "yemekhane-8914d.firebasestorage.app", messagingSenderId: "352053991912", appId: "1:352053991912:web:f4ea149d68f16ae5d8ec5d" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
    
    const getTurkiyeDate = () => { const d = new Date(); return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; };
    let allStudents = [], allCodes = [], eatenTodaySet = new Set();
    let sortDir = 1;

    // --- JS Helper for Mobile Offcanvas Close ---
    window.closeCanvas = () => {
        const el = document.getElementById('mobileMenu');
        const bsOffcanvas = bootstrap.Offcanvas.getInstance(el);
        if(bsOffcanvas) bsOffcanvas.hide();
    }

    window.login = async () => { try { await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); await setDoc(doc(db,"users",auth.currentUser.uid),{role:"admin"},{merge:true}); } catch(e){Swal.fire("Hata",e.message,"error");} };
    window.logout = () => signOut(auth).then(()=>location.reload());
    onAuthStateChanged(auth, user => { 
        if(user) { 
            document.getElementById("loginSection").classList.add("d-none"); 
            document.getElementById("dashboardSection").classList.remove("d-none"); 
            document.getElementById("mobileHeader").classList.remove("d-none"); // Mobilde header göster
            startSystem(); 
        } else {
             document.getElementById("mobileHeader").classList.add("d-none");
        }
    });

    function startSystem() {
        document.getElementById("bugunTarih").innerText = getTurkiyeDate();
        loadStudents(); 
        const bugunStr = getTurkiyeDate();
        const qToday = query(collection(db, "yemek_hareketleri"), where("tarih", "==", bugunStr));
        
        onSnapshot(qToday, snap => {
            const listDiv = document.getElementById("akisListesi"); listDiv.innerHTML="";
            let doubleCount=0; eatenTodaySet.clear();
            let groupedData = {}; 
            
            snap.forEach(d => {
                const data = d.data();
                eatenTodaySet.add(data.barkod); 
                if(data.tur === 'ikinci_ogun') doubleCount++; 
                if(!groupedData[data.barkod]) groupedData[data.barkod] = { ...data, meals: [] };
                groupedData[data.barkod].meals.push(data);
            });

            const sortedStudents = Object.values(groupedData).sort((a,b) => {
                const lastTimeA = Math.max(...a.meals.map(m => m.zaman.seconds));
                const lastTimeB = Math.max(...b.meals.map(m => m.zaman.seconds));
                return lastTimeB - lastTimeA;
            });

            sortedStudents.forEach(st => {
                st.meals.sort((a,b) => a.zaman.seconds - b.zaman.seconds);
                let badges = "";
                st.meals.forEach((m, idx) => {
                    const saat = new Date(m.zaman.seconds*1000).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
                    const isFirst = (idx === 0);
                    const label = isFirst ? 'Giriş' : (idx + 1) + '. Hak';
                    const cls = isFirst ? 'badge-soft-success' : 'badge-soft-danger'; 
                    badges += `<span class="badge ${cls} ms-1">${label} <small class="opacity-75">${saat}</small></span>`;
                });

                listDiv.innerHTML += `
                <div class="feed-row" onclick="showHistory('${st.barkod}', '${st.ad_soyad}')">
                    <div class="d-flex align-items-center">
                        <div class="ms-2">
                            <div class="fw-bold text-dark">${st.ad_soyad}</div>
                            <div class="small text-muted">${st.ogrenci_no || ''} &bull; ${st.islem_yapan_isim || 'Sistem'}</div>
                        </div>
                    </div>
                    <div class="text-end">${badges}</div>
                </div>`;
            });
            document.getElementById("lblCiftDikis").innerText = doubleCount;
            document.getElementById("lblBugunYiyen").innerText = eatenTodaySet.size;
            updateStats();
        });
    }

    window.showHistory = async (barkod, ad) => {
        document.getElementById("histName").innerText = ad;
        const ul = document.getElementById("historyList");
        ul.innerHTML = '<li class="list-group-item text-center">Yükleniyor...</li>';
        new bootstrap.Modal(document.getElementById('historyModal')).show();
        try {
            const q = query(collection(db, "yemek_hareketleri"), where("barkod", "==", barkod));
            const snap = await getDocs(q);
            ul.innerHTML = "";
            if(snap.empty) { ul.innerHTML = '<li class="list-group-item">Kayıt yok.</li>'; return; }
            let allMeals = []; snap.forEach(d => allMeals.push(d.data()));
            let mealsByDate = {};
            allMeals.forEach(m => { if(!mealsByDate[m.tarih]) mealsByDate[m.tarih] = []; mealsByDate[m.tarih].push(m); });
            Object.keys(mealsByDate).sort().reverse().slice(0, 10).forEach(tarih => {
                let dailyMeals = mealsByDate[tarih].sort((a,b) => a.zaman.seconds - b.zaman.seconds);
                dailyMeals.forEach((m, idx) => {
                    const saat = new Date(m.zaman.seconds*1000).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
                    const isFirst = (idx === 0);
                    const label = isFirst ? 'Giriş' : (idx + 1) + '. Hak';
                    const colorClass = isFirst ? 'text-success' : 'text-danger';
                    ul.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span><strong>${tarih}</strong> ${saat}</span><span class="fw-bold ${colorClass}">${label}</span></li>`;
                });
            });
        } catch (error) { ul.innerHTML = `<li class="list-group-item text-danger">Hata: ${error.message}</li>`; }
    };

    function updateStats() {
        if(allStudents.length === 0) return;
        const notEaten = Math.max(0, allStudents.length - eatenTodaySet.size);
        document.getElementById("lblYemeyen").innerText = notEaten;
        const ctx = document.getElementById('yemekPieChart').getContext('2d');
        if(window.myPie) window.myPie.destroy();
        window.myPie = new Chart(ctx, { type: 'doughnut', data: { labels: ['Yiyen', 'Bekleyen'], datasets: [{ data: [eatenTodaySet.size, notEaten], backgroundColor: ['#10b981', '#cbd5e1'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { display: false } }, cutout: '70%' } });
    }

    window.listYemeyenler = () => {
        const div = document.getElementById("yemeyenlerListesi"); div.innerHTML = "";
        const yemeyenler = allStudents.filter(s => !eatenTodaySet.has(s.barkod)).sort((a, b) => a.ad_soyad.localeCompare(b.ad_soyad));
        document.getElementById("lblYemeyen").innerText = yemeyenler.length; 
        if(yemeyenler.length === 0) div.innerHTML = "<div class='text-success text-center small py-3'><strong>Herkes yemek yedi!</strong></div>";
        yemeyenler.forEach(s => { div.innerHTML += `<div class="not-eaten-item"><span>${s.ad_soyad}</span> <span class="badge bg-light text-dark border">${s.sinif}</span></div>`; });
    };

    window.loadStudents = async () => { const s = await getDocs(collection(db,"ogrenciler")); allStudents = []; s.forEach(d=>allStudents.push(d.data())); filterStudents(); updateStats(); };
    
    window.filterStudents = () => { 
        const v = document.getElementById("studentSearch").value.toLowerCase(); 
        const tb = document.getElementById("studentListBody"); 
        tb.innerHTML = ""; 
        const f = allStudents.filter(s => (s.ad_soyad+s.numara+s.sinif+s.barkod).toLowerCase().includes(v)); 
        f.slice(0, 100).forEach(s => { 
            tb.innerHTML += `<tr>
                <td><input type="checkbox" class="st-check form-check-input" value="${s.barkod}"></td>
                <td>${s.numara}</td>
                <td class="fw-bold text-primary">${s.ad_soyad}</td>
                <td><span class="badge bg-light text-dark border">${s.sinif}</span></td>
                <td class="text-muted small font-monospace d-none d-md-table-cell">${s.barkod}</td>
                <td>
                    <button onclick="openStudentModal('edit', '${s.barkod}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button> 
                    <button onclick="deleteStudent('${s.barkod}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`; 
        }); 
    };

    window.sortStudents = (key) => { 
        sortDir *= -1; 
        allStudents.sort((a, b) => {
            let valA = a[key] ? a[key].toString() : "";
            let valB = b[key] ? b[key].toString() : "";
            if (key === 'numara' && !isNaN(valA) && !isNaN(valB)) {
                return (parseInt(valA) - parseInt(valB)) * sortDir;
            }
            return valA.localeCompare(valB, 'tr', { numeric: true }) * sortDir;
        });
        filterStudents(); 
    };

    window.openStudentModal = (mode, barkod = null) => {
        const t = document.getElementById("modalTitle"), i = document.getElementById("editBarkodInput");
        document.getElementById("editAd").value = ""; document.getElementById("editNo").value = ""; 
        document.getElementById("editSinif").value = ""; document.getElementById("editOldBarkod").value = ""; i.value = "";
        if(mode === 'add') { t.innerText = "Öğrenci Ekle"; i.placeholder = "Boş bırakılırsa otomatik üretilir"; } 
        else { t.innerText = "Öğrenci Düzenle"; const s = allStudents.find(x => x.barkod === barkod); if(s) { document.getElementById("editAd").value = s.ad_soyad; document.getElementById("editNo").value = s.numara; document.getElementById("editSinif").value = s.sinif; document.getElementById("editOldBarkod").value = s.barkod; i.value = s.barkod; } }
        new bootstrap.Modal(document.getElementById('studentModal')).show();
    };
    window.saveStudent = async () => {
        const o = document.getElementById("editOldBarkod").value, nA = document.getElementById("editAd").value, nN = document.getElementById("editNo").value, nS = document.getElementById("editSinif").value; let nB = document.getElementById("editBarkodInput").value.trim();
        if(!nA) return Swal.fire("Hata", "İsim giriniz", "warning"); if(!nB) nB = o ? o : Date.now().toString(); 
        Swal.showLoading(); try { if(o && o !== nB) await deleteDoc(doc(db, "ogrenciler", o)); await setDoc(doc(db, "ogrenciler", nB), { barkod: nB, ad_soyad: nA, numara: nN, sinif: nS, foto:"" }, {merge:true}); bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide(); await loadStudents(); Swal.fire("Başarılı", "Kayıt tamam.", "success"); } catch(e) { Swal.fire("Hata", e.message, "error"); }
    };
    window.deleteStudent = async (b) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db,"ogrenciler",b)); loadStudents(); } };
    window.toggleSelectAll = () => { document.querySelectorAll('.st-check').forEach(c => c.checked = document.getElementById("selectAll").checked); };
    window.bulkDelete = async () => { const c = document.querySelectorAll('.st-check:checked'); if(c.length === 0) return Swal.fire("Seçim Yapın", "", "warning"); if(!confirm(`${c.length} kayıt silinecek?`)) return; for(const x of c) await deleteDoc(doc(db, "ogrenciler", x.value)); loadStudents(); Swal.fire("Silindi", "", "success"); };

    window.openScannerModal = (m, u=null, n='', e='') => { document.getElementById("editScannerId").value = u||""; document.getElementById("scName").value = n; document.getElementById("scEmail").value = e; document.getElementById("scPass").value = ""; document.getElementById("scannerModalTitle").innerText = m==='add'?"Yeni Personel":"Personel Düzenle"; new bootstrap.Modal(document.getElementById('scannerModal')).show(); };
    window.saveScannerUser = async () => {
        const uid = document.getElementById("editScannerId").value, name = document.getElementById("scName").value, email = document.getElementById("scEmail").value, pass = document.getElementById("scPass").value;
        if(!name || !email || !pass) return Swal.fire("Eksik", "Tüm alanları doldurun.", "warning");
        Swal.showLoading(); if(uid) await deleteDoc(doc(db, "users", uid));
        let sa = null; try { sa = initializeApp(firebaseConfig, "ScUser"); const saAuth = getAuth(sa); const uc = await createUserWithEmailAndPassword(saAuth, email, pass); await setDoc(doc(db, "users", uc.user.uid), { email, displayName: name, role: "scanner", createdAt: new Date().toISOString() }); await signOut(saAuth); bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide(); Swal.fire("Başarılı", "Personel kaydedildi.", "success"); listScannerUsers(); } catch(e) { Swal.fire("Hata", e.message, "error"); } finally { if(sa) deleteApp(sa); }
    };
    window.listScannerUsers = async () => { const t = document.getElementById("scannerListBody"); const q = query(collection(db, "users"), where("role", "==", "scanner")); const s = await getDocs(q); t.innerHTML = s.empty ? "<tr><td colspan='4'>Kayıt yok</td></tr>" : ""; s.forEach(d => { const u = d.data(); t.innerHTML += `<tr><td class="fw-bold">${u.displayName||'-'}</td><td>${u.email}</td><td><span class="badge bg-info text-dark">Görevli</span></td><td><button onclick="openScannerModal('edit', '${d.id}', '${u.displayName}', '${u.email}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button> <button onclick="deleteScanner('${d.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`; }); };
    window.deleteScanner = async (id) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db,"users",id)); listScannerUsers(); } };
    window.changeAdminPass = async () => { const p=document.getElementById("newAdminPass").value; if(p.length<6) return Swal.fire("Hata","En az 6 karakter olmalı","warning"); try{await updatePassword(auth.currentUser,p);Swal.fire("Başarılı","Şifre güncellendi","success");document.getElementById("newAdminPass").value="";}catch(e){if(e.code==='auth/requires-recent-login'){const {value:cp}=await Swal.fire({title:'Güvenlik',text:'Mevcut şifrenizi girin:',input:'password',showCancelButton:true});if(cp){try{await reauthenticateWithCredential(auth.currentUser,EmailAuthProvider.credential(auth.currentUser.email,cp));await updatePassword(auth.currentUser,p);Swal.fire("Başarılı","Şifre güncellendi","success");}catch(z){Swal.fire("Hata","Yanlış şifre","error");}}}else{Swal.fire("Hata",e.message,"error");}}};

    window.loadVeliCodes = async () => {
        const s = await getDocs(collection(db, "veli_kodlari")); 
        allCodes = []; 
        s.forEach(d => { 
            const c = d.data(); 
            const student = allStudents.find(s => s.barkod == c.ogrenci_barkod);
            c.id = d.id;
            c.ogrAd = student ? student.ad_soyad : "Bilinmeyen";
            c.ogrNo = student ? student.numara : "-"; 
            allCodes.push(c); 
        }); 
        filterCodes(); 
        renderPrint(); 
    };

    window.filterCodes = () => { 
        const v = document.getElementById("codeSearch").value.toLowerCase(); 
        const tb = document.getElementById("codeListBody"); 
        tb.innerHTML = ""; 
        allCodes.filter(c => (c.ogrAd + c.ogrNo).toLowerCase().includes(v)).forEach(c => { 
            tb.innerHTML += `<tr>
                <td><span class="badge bg-light text-dark border">${c.ogrNo}</span></td>
                <td>${c.ogrAd}</td>
                <td class="fw-bold text-primary">${c.id}</td>
                <td>${c.kullanildi?'<span class="text-danger">Kullanıldı</span>':'Aktif'}</td>
                <td><button onclick="deleteCode('${c.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td>
            </tr>`; 
        }); 
    };

    window.renderPrint = () => { const p = document.getElementById("printArea"); p.innerHTML = ""; allCodes.filter(c=>!c.kullanildi).forEach(c => { p.innerHTML += `<div class="col-print"><div style="border:1px solid #000; padding:10px;"><h5>YEMEKHANE</h5><small>Veli Erişim Kodu</small><h3>${c.id}</h3><p>${c.ogrAd}</p></div></div>`; }); };
    window.generateMissingCodes = async () => { let c=0; const e = new Set(allCodes.map(x=>x.ogrenci_barkod)); for(const s of allStudents) { if(!e.has(s.barkod)) { await setDoc(doc(db,"veli_kodlari",Math.floor(100000+Math.random()*900000).toString()),{ogrenci_barkod:s.barkod, kullanildi:false}); c++; } } loadVeliCodes(); Swal.fire(`${c} kod üretildi`); };
    window.regenerateAllCodes = async () => { if(confirm("Tümü yenilenecek!")) { const s = await getDocs(collection(db,"veli_kodlari")); s.forEach(d=>deleteDoc(d.ref)); generateMissingCodes(); } };
    window.deleteAllCodes = async () => { if(confirm("Hepsi silinecek!")) { const s = await getDocs(collection(db,"veli_kodlari")); s.forEach(d=>deleteDoc(d.ref)); loadVeliCodes(); } };
    window.deleteCode = async (id) => { await deleteDoc(doc(db,"veli_kodlari",id)); loadVeliCodes(); };
    window.excelYukle = async () => { 
        const fi = document.getElementById('excelDosyasi'); if(fi.files.length===0) return Swal.fire("Uyarı","Dosya seçiniz","warning");
        Swal.showLoading();
        const r = new FileReader();
        r.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type:'array'});
                const j = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let c=0; 
                for(const ogr of j) { 
                    if(ogr.barkod && ogr.ad_soyad) { 
                        const b=String(ogr.barkod).trim(); 
                        await setDoc(doc(db,"ogrenciler",b),{barkod:b,ad_soyad:ogr.ad_soyad,sinif:ogr.sinif?String(ogr.sinif).trim():"-",numara:ogr.numara?String(ogr.numara).trim():"",foto:ogr.foto||""}); c++; 
                    } 
                }
                Swal.fire("Tamam", `${c} yüklendi.`, "success"); loadStudents();
            } catch(z) { Swal.fire("Hata",z.message,"error"); }
        }; r.readAsArrayBuffer(fi.files[0]);
    };
    window.showTab = (id, el) => { document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('d-none')); document.getElementById('tab-'+id).classList.remove('d-none'); document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active')); if(el)el.classList.add('active'); };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>