<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yemekhane Komuta Merkezi</title>
    <link rel="icon" type="image/jpeg" href="admin.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .sidebar { min-height: 100vh; background: #1a202c; color: white; }
        .nav-link { color: #cbd5e0; margin-bottom: 5px; cursor: pointer; border-radius: 8px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: #2d3748; color: white; padding-left: 20px; }
        .card-dash { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); background: white; }
        .table-responsive { max-height: 600px; overflow-y: auto; }

        /* CANLI AKIŞ TASARIMI */
        .flow-row { transition: all 0.2s ease; border-left: 5px solid transparent; cursor: pointer; }
        .flow-row:hover { background-color: #f1f3f5; border-left: 5px solid #1e3c72; transform: translateX(3px); }
        
        .meal-badge {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px 10px; border-radius: 8px; min-width: 85px;
            border: 1px solid rgba(0,0,0,0.1); font-size: 0.9rem;
        }
        .meal-time { font-weight: bold; font-size: 1rem; }
        .meal-staff { font-size: 0.65rem; opacity: 0.8; margin-top: 2px; text-transform: lowercase; }
        .badge-normal { background-color: #d1e7dd; color: #0f5132; }
        .badge-double { background-color: #f8d7da; color: #842029; }

        /* MODAL ZAMAN ÇİZELGESİ */
        .timeline-item { padding: 15px; border-left: 3px solid #e9ecef; position: relative; background: white; transition: 0.3s; }
        .timeline-item:hover { background-color: #f8f9fa; border-left-color: #1e3c72; }
        .timeline-date { font-size: 0.85rem; color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .timeline-content { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .staff-tag { font-size: 0.75rem; background: #e2e3e5; padding: 2px 8px; border-radius: 4px; color: #495057; }

        /* YAZDIRMA */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
            .veli-kart { width: 85mm; height: 55mm; border: 1px dashed #333; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: white !important; -webkit-print-color-adjust: exact; page-break-inside: avoid; }
            .no-print { display: none !important; }
        }
        .veli-kart { background: white; border-radius: 10px; margin-bottom: 10px; border: 1px solid #ddd; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="loginSection" class="d-flex justify-content-center align-items-center vh-100 bg-dark">
    <div class="card p-5 rounded-4 shadow-lg text-center" style="width: 400px;">
        <div class="mb-4 text-primary"><i class="fas fa-shield-alt fa-4x"></i></div>
        <h3 class="fw-bold mb-3">YÖNETİM PANELİ</h3>
        <p class="text-muted small mb-4">Yetkili girişi yapınız.</p>
        <div class="form-floating mb-3"><input type="email" id="email" class="form-control" placeholder="E-Posta"><label>E-Posta Adresi</label></div>
        <div class="form-floating mb-3"><input type="password" id="password" class="form-control" placeholder="Şifre"><label>Şifre</label></div>
        <button onclick="window.login()" class="btn btn-primary w-100 py-2 fw-bold">GİRİŞ YAP</button>
    </div>
</div>

<div id="dashboardSection" class="container-fluid d-none">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar p-3">
            <h4 class="fw-bold mb-4 px-2 text-warning"><i class="fas fa-utensils me-2"></i>YEMEKHANE</h4>
            <ul class="nav flex-column gap-2">
                <li class="nav-item"><a class="nav-link active" onclick="window.showTab('main', this)"><i class="fas fa-chart-pie"></i> Genel Bakış</a></li>
                <li class="nav-item"><a class="nav-link" onclick="window.showTab('students', this); window.loadStudents();"><i class="fas fa-user-graduate"></i> Öğrenciler</a></li>
                <li class="nav-item"><a class="nav-link" onclick="window.showTab('codes', this); window.loadVeliCodes();"><i class="fas fa-qrcode"></i> Veli Kodları</a></li>
                <li class="nav-item"><a class="nav-link" onclick="window.showTab('users', this); window.listScannerUsers();"><i class="fas fa-users-cog"></i> Personel</a></li>
            </ul>
            <div class="mt-auto pt-5"><a class="nav-link text-danger fw-bold" onclick="window.logout()"><i class="fas fa-sign-out-alt"></i> Çıkış</a></div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            
            <div id="tab-main" class="tab-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold text-dark">Komuta Merkezi</h2><span class="badge bg-primary fs-6" id="bugunTarih"></span>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="card card-dash bg-success text-white p-3 h-100"><h6>BUGÜN YİYEN</h6><h1 class="display-4 fw-bold mb-0" id="lblBugunYiyen">0</h1></div></div>
                    <div class="col-md-4"><div class="card card-dash bg-danger text-white p-3 h-100"><h6>ÇİFT DİKİŞ</h6><h1 class="display-4 fw-bold mb-0" id="lblCiftDikis">0</h1></div></div>
                    <div class="col-md-4"><div class="card card-dash p-3 h-100"><canvas id="yemekChart" style="max-height: 120px;"></canvas></div></div>
                </div>
                <div class="card card-dash p-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2 text-primary">Canlı Akış (Günlük Özet)</h5>
                    <div id="akisListesi" style="max-height: 600px; overflow-y: auto;">
                        <div class="text-center py-5 text-muted">Veriler yükleniyor...</div>
                    </div>
                </div>
            </div>

            <div id="tab-students" class="tab-content d-none">
                <h3 class="mb-4">Öğrenci Yönetimi</h3>
                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="card card-dash p-3 h-100 border-start border-4 border-success"><h6 class="fw-bold text-success"><i class="fas fa-file-excel me-2"></i>Toplu Yükle</h6><input type="file" id="excelDosyasi" class="form-control form-control-sm mb-2" accept=".xlsx" /><button onclick="window.excelYukle()" class="btn btn-sm btn-success w-100">Listeyi İşle</button></div></div>
                    <div class="col-md-4"><div class="card card-dash p-3 h-100 border-start border-4 border-primary"><h6 class="fw-bold text-primary"><i class="fas fa-user-plus me-2"></i>Manuel Ekle</h6><button onclick="window.openStudentModal()" class="btn btn-sm btn-primary w-100 mt-auto">Yeni Öğrenci Ekle</button></div></div>
                    <div class="col-md-4"><div class="card card-dash p-3 h-100 border-start border-4 border-info"><h6 class="fw-bold text-info"><i class="fas fa-search me-2"></i>Ara & Bul</h6><input type="text" id="studentSearch" class="form-control" placeholder="Ad, Numara veya Sınıf..." onkeyup="window.filterStudents()"></div></div>
                </div>
                <div class="card card-dash p-4"><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Barkod</th><th>Numara</th><th>Ad Soyad</th><th>Sınıf</th><th>İşlem</th></tr></thead><tbody id="studentListBody"><tr><td colspan="5" class="text-center">Yükleniyor...</td></tr></tbody></table></div></div>
            </div>

            <div id="tab-codes" class="tab-content d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Veli Erişim Kodları</h3>
                    <div>
                        <button onclick="window.generateMissingCodes()" class="btn btn-primary fw-bold" title="Sadece kodu olmayanlar için üretir"><i class="fas fa-plus-circle me-1"></i>Eksikleri Tamamla</button>
                        <button onclick="window.regenerateAllCodes()" class="btn btn-danger fw-bold ms-2" title="Herkesin kodunu silip yeniden üretir"><i class="fas fa-sync-alt me-1"></i>Tümünü Sil ve Yeniden Üret</button>
                        <button onclick="window.print()" class="btn btn-dark fw-bold ms-2"><i class="fas fa-print me-1"></i>Yazdır</button>
                    </div>
                </div>
                <ul class="nav nav-tabs mb-3 no-print"><li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#code-list">Liste Görünümü</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#code-print">Baskı Önizleme</a></li></ul>
                <div class="tab-content">
                    <div id="code-list" class="tab-pane fade show active no-print"><div class="card card-dash p-4"><input type="text" id="codeSearch" class="form-control mb-3" placeholder="Öğrenci ara..." onkeyup="window.filterCodes()"><div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>Öğrenci</th><th>Kod</th><th>Durum</th><th>İşlem</th></tr></thead><tbody id="codeListBody"></tbody></table></div></div></div>
                    <div id="code-print" class="tab-pane fade"><div id="printArea" class="row"></div></div>
                </div>
            </div>

            <div id="tab-users" class="tab-content d-none">
                <h3 class="mb-4">Personel Yönetimi</h3>
                <div class="row g-4">
                    <div class="col-md-5"><div class="card card-dash p-4 border-start border-4 border-primary"><h5 class="fw-bold text-primary mb-3">Yeni Görevli Ekle</h5><div class="form-floating mb-2"><input type="email" id="newScannerEmail" class="form-control" placeholder="Email"><label>E-Posta</label></div><div class="form-floating mb-3"><input type="text" id="newScannerPass" class="form-control" placeholder="Şifre"><label>Şifre</label></div><button onclick="window.createScannerUser()" class="btn btn-primary w-100">Oluştur</button></div><div class="card card-dash p-4 mt-4 border-start border-4 border-danger"><h5 class="fw-bold text-danger mb-2">Admin Şifre</h5><input type="text" id="newAdminPass" class="form-control mb-2" placeholder="Yeni Şifre"><button onclick="window.changeAdminPass()" class="btn btn-danger w-100 btn-sm">Güncelle</button></div></div>
                    <div class="col-md-7"><div class="card card-dash p-4 h-100"><div class="d-flex justify-content-between align-items-center mb-3"><h5 class="fw-bold mb-0">Aktif Görevliler</h5><button onclick="window.listScannerUsers()" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync"></i></button></div><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>E-Posta</th><th>Tarih</th><th>İşlem</th></tr></thead><tbody id="scannerListBody"></tbody></table></div></div></div>
                </div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="ogrenciModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Öğrenci Detayı</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="text-center bg-light p-4"><img id="modalFoto" src="" class="rounded-circle shadow border border-3 border-white" style="width:120px;height:120px;object-fit:cover;"><h3 id="modalAd" class="fw-bold mt-2"></h3><span class="badge bg-warning text-dark px-3" id="modalSinif"></span></div><div class="p-3"><div id="modalGecmisList" style="max-height:300px;overflow-y:auto;"></div></div></div></div></div></div>
<div class="modal fade" id="addStudentModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Öğrenci Ekle</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="addBarkod" class="form-control mb-2" placeholder="Barkod"><input type="text" id="addAd" class="form-control mb-2" placeholder="Ad Soyad"><input type="text" id="addNumara" class="form-control mb-2" placeholder="Numara"><input type="text" id="addSinif" class="form-control mb-2" placeholder="Sınıf"></div><div class="modal-footer"><button onclick="window.saveStudent()" class="btn btn-success">Kaydet</button></div></div></div></div>

<script type="module">
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, updatePassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, getDocs, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyC2ATSLTN8ba3pao1kKd2cT1vHcT8rafT8", authDomain: "yemekhane-8914d.firebaseapp.com", projectId: "yemekhane-8914d", storageBucket: "yemekhane-8914d.firebasestorage.app", messagingSenderId: "352053991912", appId: "1:352053991912:web:f4ea149d68f16ae5d8ec5d" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); window.db = db;
    document.getElementById("bugunTarih").innerText = new Date().toLocaleDateString('tr-TR');
    
    let allStudents = [], allCodes = [];

    // --- FONKSİYONLAR ---
    window.login = async () => {
        const e = document.getElementById("email").value; const p = document.getElementById("password").value;
        Swal.fire({title:'Giriş...',didOpen:()=>{Swal.showLoading()}});
        try { await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth, e, p); await setDoc(doc(db, "users", auth.currentUser.uid), { role: "admin", email: e }, { merge: true }); Swal.close(); } 
        catch(err) { Swal.fire("Hata", err.message, "error"); }
    };
    window.logout = async () => { await signOut(auth); location.reload(); };

    window.veriAkisiniBaslat = () => {
        const q = query(collection(db, "yemek_hareketleri"), orderBy("zaman", "desc"));
        onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById("akisListesi"); if(!listDiv) return; listDiv.innerHTML = "";
            let groupedData = {}; let bugunYiyenSet = new Set(); let ciftSayisi = 0; const bugunStr = new Date().toISOString().split('T')[0];
            snapshot.forEach(doc => {
                const d = doc.data();
                if(!groupedData[d.tarih]) groupedData[d.tarih] = {};
                if(!groupedData[d.tarih][d.barkod]) { groupedData[d.tarih][d.barkod] = { ad_soyad: d.ad_soyad, ogrenci_no: d.ogrenci_no, hareketler: [], son_islem: 0 }; }
                groupedData[d.tarih][d.barkod].hareketler.push(d);
                if(d.zaman.seconds > groupedData[d.tarih][d.barkod].son_islem) groupedData[d.tarih][d.barkod].son_islem = d.zaman.seconds;
                if(d.tarih === bugunStr) { bugunYiyenSet.add(d.barkod); if(d.tur === 'ikinci_ogun') ciftSayisi++; }
            });
            if(document.getElementById("lblBugunYiyen")) document.getElementById("lblBugunYiyen").innerText = bugunYiyenSet.size;
            if(document.getElementById("lblCiftDikis")) document.getElementById("lblCiftDikis").innerText = ciftSayisi;
            grafikGuncelle(bugunYiyenSet.size);
            Object.keys(groupedData).sort().reverse().forEach(tarih => {
                let html = `<div class="mb-4"><h6 class="border-bottom pb-2 text-primary fw-bold">${tarih}</h6><div class="d-flex flex-column gap-2">`;
                const students = Object.values(groupedData[tarih]).sort((a,b)=>b.son_islem-a.son_islem);
                students.forEach(st => {
                    st.hareketler.sort((a,b)=>a.zaman.seconds-b.zaman.seconds);
                    let badges = "";
                    st.hareketler.forEach((m, idx) => {
                        const saat = new Date(m.zaman.seconds*1000).toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'});
                        const staff = m.islem_yapan ? m.islem_yapan.split('@')[0] : '...';
                        const cls = m.tur==='ikinci_ogun' ? 'badge-double' : 'badge-normal';
                        badges += `<div class="meal-badge ${cls}" title="${m.islem_yapan}"><div class="meal-time">${saat}</div><div class="meal-staff">${staff}</div></div>`;
                    });
                    html += `<div class="card shadow-sm border-0 flow-row" onclick="window.detayAc('${st.hareketler[0].barkod}')"><div class="card-body p-2 d-flex align-items-center justify-content-between flex-wrap"><div class="d-flex align-items-center" style="min-width:200px;"><div class="bg-light rounded-circle d-flex align-items-center justify-content-center fw-bold text-secondary me-3 border" style="width:40px;height:40px;">${st.ad_soyad.charAt(0)}</div><div><h6 class="fw-bold mb-0 text-dark">${st.ad_soyad}</h6><small class="text-muted">${st.ogrenci_no||'-'}</small></div></div><div class="d-flex align-items-center gap-2">${badges}</div></div></div>`;
                }); html += `</div></div>`; listDiv.innerHTML += html;
            });
        });
    };

    window.detayAc = async (barkod) => {
        const modal = new bootstrap.Modal(document.getElementById('ogrenciModal'));
        document.getElementById("modalGecmisList").innerHTML = '<div class="text-center py-4">Yükleniyor...</div>';
        modal.show();
        try {
            let ad="Bilinmiyor", sinif="-", foto="";
            const qOgr = query(collection(db, "ogrenciler"), where("barkod", "==", barkod));
            const snapOgr = await getDocs(qOgr);
            if(!snapOgr.empty) { const d=snapOgr.docs[0].data(); ad=d.ad_soyad; sinif=d.sinif; foto=d.foto; }
            else if(barkod.startsWith("MISAFIR")) { ad="MİSAFİR"; sinif="Ziyaretçi"; }
            document.getElementById("modalAd").innerText=ad; document.getElementById("modalSinif").innerText=sinif; 
            document.getElementById("modalFoto").src=foto||"https://cdn-icons-png.flaticon.com/512/3233/3233497.png";
            const qYemek = query(collection(db, "yemek_hareketleri"), where("barkod", "==", barkod));
            const snapYemek = await getDocs(qYemek);
            let list = []; snapYemek.forEach(d=>list.push(d.data())); list.sort((a,b)=>b.zaman.seconds-a.zaman.seconds);
            const ul = document.getElementById("modalGecmisList"); ul.innerHTML = "";
            list.forEach(y => {
                const tarih = y.tarih; const saat = new Date(y.zaman.seconds*1000).toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'});
                const staff = y.islem_yapan ? y.islem_yapan.split('@')[0] : 'Sistem';
                const rozet = y.tur==='ikinci_ogun' ? '<span class="badge bg-danger rounded-pill">2. Hak</span>' : '<span class="badge bg-success rounded-pill">Giriş</span>';
                ul.innerHTML += `<li class="timeline-item border-start ${y.tur==='ikinci_ogun'?'border-danger':'border-success'}"><div class="timeline-date">${tarih}</div><div class="timeline-content"><div><span class="fs-5 fw-bold text-dark me-2">${saat}</span>${rozet}</div><div class="staff-tag">${staff}</div></div></li><hr class="my-0 opacity-25">`;
            });
        } catch(e) { document.getElementById("modalGecmisList").innerHTML = "Hata."; }
    };

    window.loadStudents = async () => { const s = await getDocs(collection(db, "ogrenciler")); allStudents = []; s.forEach(d => allStudents.push(d.data())); window.filterStudents(); };
    window.filterStudents = () => {
        const v = document.getElementById("studentSearch").value.toLowerCase(); const tb = document.getElementById("studentListBody"); tb.innerHTML = "";
        const f = allStudents.filter(s => (s.ad_soyad&&s.ad_soyad.toLowerCase().includes(v)) || (s.numara&&s.numara.toString().includes(v)) || (s.sinif&&s.sinif.toLowerCase().includes(v)));
        if(f.length===0) tb.innerHTML='<tr><td colspan="5" class="text-center">Yok.</td></tr>';
        f.slice(0,100).forEach(s => { tb.innerHTML+=`<tr><td>${s.barkod}</td><td>${s.numara}</td><td>${s.ad_soyad}</td><td><span class="badge bg-secondary">${s.sinif}</span></td><td><button onclick="window.deleteStudent('${s.barkod}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`; });
    };
    window.openStudentModal = () => { document.getElementById("addBarkod").value=""; document.getElementById("addAd").value=""; document.getElementById("addNumara").value=""; new bootstrap.Modal(document.getElementById('addStudentModal')).show(); };
    window.saveStudent = async () => {
        let b = document.getElementById("addBarkod").value.trim(); const a = document.getElementById("addAd").value.trim();
        const n = document.getElementById("addNumara").value.trim(); const s = document.getElementById("addSinif").value.trim();
        if(!a) return Swal.fire("Hata","Ad girin","warning"); if(!b) b = new Date().getTime().toString();
        try { await setDoc(doc(db,"ogrenciler",b),{barkod:b,ad_soyad:a,numara:n,sinif:s,foto:""}); Swal.fire("Ok","Eklendi","success"); window.loadStudents(); } catch(e){Swal.fire("Hata",e.message,"error");}
    };
    window.deleteStudent = async (b) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db,"ogrenciler",b)); window.loadStudents(); } };
    window.excelYukle = async () => {
        const fi = document.getElementById('excelDosyasi'); if(fi.files.length===0) return Swal.fire("Uyarı","Dosya seçiniz","warning");
        Swal.fire({title:'İşleniyor...',didOpen:()=>{Swal.showLoading()}});
        const r = new FileReader();
        r.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type:'array'});
                const j = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let c=0; for(const ogr of j) { if(ogr.barkod && ogr.ad_soyad) { const b=String(ogr.barkod).trim(); await setDoc(doc(db,"ogrenciler",b),{barkod:b,ad_soyad:ogr.ad_soyad,sinif:ogr.sinif?String(ogr.sinif).trim():"-",numara:ogr.numara?String(ogr.numara).trim():"",foto:ogr.foto||""}); c++; } }
                Swal.fire("Tamam", `${c} yüklendi.`, "success"); window.loadStudents();
            } catch(z) { Swal.fire("Hata",z.message,"error"); }
        }; r.readAsArrayBuffer(fi.files[0]);
    };

    // --- VELİ KODLARI (DÜZELTİLMİŞ) ---
    window.loadVeliCodes = async () => {
        // Öğrenci listesi boşsa çek
        if(allStudents.length===0) { const s=await getDocs(collection(db,"ogrenciler")); allStudents=[]; s.forEach(d=>allStudents.push(d.data())); }
        
        const sc = await getDocs(collection(db, "veli_kodlari")); allCodes = [];
        sc.forEach(d => { 
            const c=d.data(); c.id=d.id; 
            const o=allStudents.find(s=>s.barkod===c.ogrenci_barkod); 
            c.ogrAd=o?o.ad_soyad:"Bilinmeyen"; 
            allCodes.push(c); 
        });
        window.filterCodes(); window.renderPrintArea();
    };
    window.filterCodes = () => {
        const v = document.getElementById("codeSearch").value.toLowerCase(); const tb = document.getElementById("codeListBody"); tb.innerHTML="";
        const f = allCodes.filter(c=>c.ogrAd.toLowerCase().includes(v)||c.id.includes(v));
        f.slice(0,100).forEach(c=>{ const st=c.kullanildi?'<span class="badge bg-danger">Kullanıldı</span>':'<span class="badge bg-success">Aktif</span>'; tb.innerHTML+=`<tr><td>${c.ogrAd}</td><td class="fw-bold">${c.id}</td><td>${st}</td><td><button onclick="window.deleteCode('${c.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`; });
    };
    window.renderPrintArea = () => {
        const d = document.getElementById("printArea"); d.innerHTML="";
        allCodes.filter(c=>!c.kullanildi).forEach(c=>{d.innerHTML+=`<div class="col-md-3"><div class="veli-kart"><h6>YEMEKHANE</h6><small>Veli Şifresi</small><div class="fs-2 fw-bold border border-dark px-2 my-1">${c.id}</div><div>${c.ogrAd}</div></div></div>`;});
    };
    
    // YENİDEN DÜZENLENEN KOD ÜRETME FONKSİYONLARI
    window.generateMissingCodes = async () => {
        Swal.fire({title:'İşleniyor...',didOpen:()=>{Swal.showLoading()}});
        
        // Veritabanından taze liste çek
        const stSnap = await getDocs(collection(db,"ogrenciler"));
        const students = []; stSnap.forEach(d=>students.push(d.data()));
        
        const cdSnap = await getDocs(collection(db,"veli_kodlari"));
        const existingBarcodes = new Set();
        cdSnap.forEach(d=>existingBarcodes.add(d.data().ogrenci_barkod));

        let count=0;
        const promises = [];
        for(const s of students) { 
            if(!existingBarcodes.has(s.barkod)) { 
                const kod = Math.floor(100000+Math.random()*900000).toString(); 
                promises.push(setDoc(doc(db,"veli_kodlari",kod),{ogrenci_barkod:s.barkod,kullanildi:false}));
                count++; 
            } 
        }
        await Promise.all(promises);
        Swal.fire("Tamam", `${count} yeni kod üretildi.`, "success"); 
        window.loadVeliCodes();
    };

    window.regenerateAllCodes = async () => {
        if(!confirm("DİKKAT: Tüm kodlar silinip yeniden üretilecek!")) return; 
        Swal.fire({title:'Yenileniyor...',didOpen:()=>{Swal.showLoading()}});
        
        // 1. Sil
        const cdSnap = await getDocs(collection(db,"veli_kodlari")); 
        const delPromises = cdSnap.docs.map(d => deleteDoc(doc(db,"veli_kodlari",d.id)));
        await Promise.all(delPromises);
        
        // 2. Çek
        const stSnap = await getDocs(collection(db,"ogrenciler"));
        const students = []; stSnap.forEach(d=>students.push(d.data()));
        
        // 3. Üret
        const createPromises = students.map(st => {
            const kod = Math.floor(100000+Math.random()*900000).toString(); 
            return setDoc(doc(db,"veli_kodlari",kod),{ogrenci_barkod:st.barkod,kullanildi:false}); 
        });
        await Promise.all(createPromises);
        
        Swal.fire("Ok","Tümü yenilendi","success"); 
        window.loadVeliCodes();
    };
    window.deleteCode = async (id) => { if(confirm("Sil?")) { await deleteDoc(doc(db,"veli_kodlari",id)); window.loadVeliCodes(); } };

    // PERSONEL
    window.createScannerUser = async () => {
        const e=document.getElementById("newScannerEmail").value; const p=document.getElementById("newScannerPass").value;
        if(!e||!p) return Swal.fire("Eksik","Bilgi gir","warning");
        Swal.fire({title:'Ekleniyor...',didOpen:()=>{Swal.showLoading()}});
        let sa=null; try { sa=initializeApp(firebaseConfig,"SC"+Date.now()); const sAuth=getAuth(sa); const uc=await createUserWithEmailAndPassword(sAuth,e,p); await setDoc(doc(db,"users",uc.user.uid),{email:e,role:"scanner",createdAt:new Date().toISOString()}); await signOut(sAuth); Swal.fire("Tamam","Eklendi","success"); listScannerUsers(); } catch(z){Swal.fire("Hata",z.message,"error");} finally{if(sa)deleteApp(sa);}
    };
    window.listScannerUsers = async () => {
        const tb=document.getElementById("scannerListBody"); tb.innerHTML='<tr><td colspan="3">...</td></tr>';
        try{const q=query(collection(db,"users"),where("role","==","scanner"));const s=await getDocs(q);tb.innerHTML=""; s.forEach(d=>{const u=d.data(); tb.innerHTML+=`<tr><td>${u.email}</td><td>${u.createdAt||'-'}</td><td><button onclick="window.deleteScanner('${d.id}', '${u.email}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button></td></tr>`;});}catch(e){tb.innerHTML=e.message;}
    };
    window.deleteScanner = async (uid, email) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db,"users",uid)); window.listScannerUsers(); } };
    window.changeAdminPass = async () => { const p=document.getElementById("newAdminPass").value; if(p.length<6) return alert("Kısa"); try{await updatePassword(auth.currentUser,p);alert("Tamam");}catch(e){alert(e.message);} };

    let myChart; const grafikGuncelle = (v) => { const c=document.getElementById('yemekChart');if(!c)return;const x=c.getContext('2d');if(myChart)myChart.destroy();myChart=new Chart(x,{type:'bar',data:{labels:['Yiyen'],datasets:[{label:'Kişi',data:[v],backgroundColor:['#198754']}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false}}); };
    window.showTab = (id, el) => { document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('d-none')); document.getElementById('tab-'+id).classList.remove('d-none'); document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active')); if(el)el.classList.add('active'); };

    onAuthStateChanged(auth, (user) => {
        if (user) { document.getElementById("loginSection").classList.add("d-none"); document.getElementById("dashboardSection").classList.remove("d-none"); window.veriAkisiniBaslat(); } 
        else { document.getElementById("loginSection").classList.remove("d-none"); document.getElementById("dashboardSection").classList.add("d-none"); }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>