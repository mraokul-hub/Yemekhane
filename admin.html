<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yemekhane Yönetimi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/jpeg" href="Admin.jpg">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { 
            --bg-body: #e3e8ef; --bg-sidebar: #ffffff; --bg-card: #ffffff;          
            --text-main: #1e293b; --text-muted: #64748b;       
            --primary: #2563eb; --primary-hover: #1d4ed8; --primary-light: #eff6ff;    
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --border-color: #e2e8f0; --border-radius: 16px;       
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
        #loginSection { background: var(--bg-body); background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 24px 24px; }
        .login-card { background: var(--bg-card); border-radius: var(--border-radius); padding: 40px; width: 100%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: var(--shadow-card); }
        .sidebar { background-color: var(--bg-sidebar); min-height: 100vh; border-right: 1px solid var(--border-color); box-shadow: 4px 0 15px rgba(0,0,0,0.02); }
        .sidebar-logo { width: 90px; height: 90px; object-fit: cover; border-radius: 50%; border: 4px solid var(--bg-body); margin-bottom: 15px; box-shadow: var(--shadow-sm); }
        .nav-link { color: var(--text-muted); margin-bottom: 5px; border-radius: 10px; padding: 12px 20px; font-weight: 600; transition: all 0.2s ease; }
        .nav-link:hover { background-color: var(--bg-body); color: var(--primary); transform: translateX(3px); }
        .nav-link.active { background-color: var(--primary-light); color: var(--primary); border-right: 4px solid var(--primary); }
        .admin-card { background: var(--bg-card); border-radius: var(--border-radius); box-shadow: var(--shadow-card); padding: 20px; margin-bottom: 20px; border: 1px solid #fff; height: 100%; }
        
        .stat-card-new { display: flex; align-items: center; justify-content: space-between; padding: 20px; transition: transform 0.2s; }
        .stat-card-new:hover { transform: translateY(-3px); }
        .stat-icon-box { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .stat-info h6 { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; font-weight: 700; }
        .stat-info h3 { font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin: 0; line-height: 1; }

        .form-control { background-color: #f8fafc; border: 1px solid #cbd5e1; padding: 12px; border-radius: 10px; color: var(--text-main); }
        .form-control:focus { background-color: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .btn-primary { background-color: var(--primary); border: none; padding: 10px 24px; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn-warning { background-color: var(--warning); border:none; color:white; border-radius:10px; font-weight: 600; }
        .btn-danger { background-color: var(--danger); border:none; border-radius:10px; }
        .btn-secondary { background-color: var(--text-muted); border:none; border-radius:10px; }
        .table thead th { background-color: #f8fafc; color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; border-bottom: 1px solid var(--border-color); padding: 15px; }
        .table tbody td { padding: 15px; vertical-align: middle; }
        .sortable-th { cursor: pointer; transition: 0.2s; user-select: none; }
        
        /* Akış Listesi İyileştirme */
        .feed-row { padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s ease; border-radius: 8px; margin-bottom: 4px; position: relative; }
        .feed-row:hover { background-color: #f8fafc; transform: translateX(3px); }
        .feed-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        
        /* Silme butonu için özel stil - Mobilde parmakla basmayı kolaylaştırır */
        .delete-btn-wrapper {
            display: inline-block;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 100;
            position: relative;
        }
        
        .badge-soft-success { background-color: #d1fae5; color: #065f46; }
        .badge-soft-danger { background-color: #fee2e2; color: #991b1b; }
        .sort-btn { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; border: 1px solid #ddd; background: white; color: #555; margin-left: 3px; cursor: pointer; }
        .sort-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Foto Yükleme */
        .photo-upload-container { position: relative; width: 120px; height: 140px; margin: 0 auto 20px; border: 2px dashed #cbd5e1; border-radius: 10px; overflow: hidden; background: #f8fafc; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .photo-upload-container:hover { border-color: var(--primary); background: #eff6ff; }
        .photo-upload-container img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-upload-container.has-img img { display: block; }
        .photo-upload-container.has-img .upload-placeholder { display: none; }
        .upload-placeholder { text-align: center; color: var(--text-muted); }
        .upload-placeholder i { font-size: 2rem; margin-bottom: 5px; display: block; }
        .upload-placeholder span { font-size: 0.7rem; font-weight: 600; }
        #editFotoInput { display: none; }
        #bulkUploadLog { max-height: 200px; overflow-y: auto; background: #2d3436; color: #00b894; font-family: monospace; font-size: 0.8rem; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 10px; }

        /* ========= BASKI STİLLERİ ========= */
        #printArea { display: none; }
        @media print {
            body * { visibility: hidden; }
            #dashboardSection, .sidebar, #loginSection, .offcanvas { display: none !important; }
            #printArea { display: block !important; visibility: visible !important; position: absolute; left: 0; top: 0; width: 210mm; margin: 0; padding: 5mm; }
            #printArea * { visibility: visible !important; }
            .print-page { width: 100%; page-break-after: always; display: grid; justify-items: center; align-content: start; }
            .print-page.cards { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(4, auto); gap: 5mm; padding-top: 5mm; }
            .print-page.codes { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(5, auto); gap: 5mm; padding-top: 5mm; }
            .meal-card-container { width: 86mm; height: 54mm; position: relative; background-size: 100% 100%; background-position: center; background-repeat: no-repeat; border: 1px solid #ddd; border-radius: 3mm; -webkit-print-color-adjust: exact; print-color-adjust: exact; margin-bottom: 5mm; }
            .card-photo-box { position: absolute; top: 19mm; left: 4.5mm; width: 26mm; height: 30mm; display: flex; align-items: center; justify-content: center; overflow: hidden; }
            .card-photo { width: 100%; height: 100%; object-fit: cover; border-radius: 2mm; }
            .card-info-area { position: absolute; top: 19mm; left: 34mm; width: 48mm; color: #580f1d; font-family: 'Inter', sans-serif; font-size: 8pt; line-height: 1.5; font-weight: 600; }
            .info-row { display: flex; margin-bottom: 1.5mm; }
            .info-label { width: 18mm; font-weight: 700; color: #580f1d; }
            .info-sep { width: 3mm; text-align: center; font-weight: 700; }
            .info-val { flex: 1; font-weight: 500; color: #000; }
            .card-qr-area { position: absolute; bottom: 3.5mm; right: 3.5mm; width: 20mm; height: 20mm; display: flex; align-items: center; justify-content: center; }
            .card-qr-area img { width: 61px !important; height: 61px !important; }
            .code-card-print { width: 60mm; height: 50mm; border: 2px dashed #333; padding: 5mm; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; margin-bottom: 5mm; }
        }

        /* ========= MOBİL UYUMLULUK ========= */
        @media (max-width: 767.98px) { 
            .sidebar { position: fixed; top: 0; left: -250px; width: 250px; transition: left 0.3s; z-index: 1050; min-height: 100vh; } 
            .sidebar.show { left: 0; } 
            main { width: 100% !important; padding-left: 10px !important; padding-right: 10px !important; margin-left: 0 !important; } 
            #mobile-menu-btn { display: block; } 
            
            /* İstatistik kartları mobilde 2'li görünsün */
            .row.g-3.mb-4 > .col-6 { width: 50%; }
            .stat-icon-box { width: 40px; height: 40px; font-size: 1.2rem; }
            .stat-info h3 { font-size: 1.4rem; }
            
            /* Anlık akış listesi */
            .feed-row { padding: 10px 5px; }
            .feed-avatar { width: 35px; height: 35px; font-size: 0.9rem; margin-right: 8px; }
            .feed-row .fw-bold { font-size: 0.95rem; }
            
            /* Silme butonu mobilde daha büyük basma alanı */
            .delete-btn-wrapper { padding: 8px 15px; margin-left: 5px; }
            
            /* Kart yüksekliği mobilde sabit olmasın */
            .admin-card[style*="min-height: 500px"] { min-height: 400px !important; }
        }
        #mobile-menu-btn { display: none; }
    </style>
</head>
<body>

<div id="loginSection" class="d-flex justify-content-center align-items-center vh-100">
    <div class="login-card text-center">
        <img src="logo.jpg" alt="Logo" class="sidebar-logo shadow-sm">
        <h4 class="fw-bold mb-1 text-dark">YÖNETİCİ GİRİŞİ</h4>
        <input type="email" id="email" class="form-control mb-3" placeholder="E-Posta Adresi">
        <input type="password" id="password" class="form-control mb-4" placeholder="Şifre">
        <button onclick="window.login()" class="btn btn-primary w-100 py-3">GÜVENLİ GİRİŞ</button>
    </div>
</div>

<div id="dashboardSection" class="container-fluid d-none">
    <div class="row">
        <button class="btn btn-primary d-md-none rounded-0" id="mobile-menu-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar"><i class="fas fa-bars me-2"></i> Menü</button>

        <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar p-3 text-center text-md-start">
            <div class="text-center py-4 border-bottom mb-3" style="border-color: var(--bg-body) !important;">
                <img src="logo.jpg" alt="Logo" class="sidebar-logo">
                <h6 class="fw-bold text-dark mb-0 mt-2" style="letter-spacing: 1px;">YEMEKHANE</h6>
                <small class="text-muted" style="font-size: 0.7rem;">YÖNETİM PANELİ</small>
            </div>
            <ul class="nav flex-column gap-2">
                <li class="nav-item"><a class="nav-link active" onclick="showTab('main', this)"><i class="fas fa-chart-line"></i> Genel Bakış</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('students', this); loadStudents();"><i class="fas fa-user-graduate"></i> Öğrenci İşlemleri</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('codes', this); loadVeliCodes();"><i class="fas fa-qrcode"></i> Erişim Kodları</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('cards', this); loadCardPrinting();"><i class="fas fa-id-card"></i> Kart Basım</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('reports', this)"><i class="fas fa-file-excel"></i> Raporlar</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('users', this); listScannerUsers();"><i class="fas fa-users-cog"></i> Personel Yönetimi</a></li>
            </ul>
            <div class="mt-auto pt-5 pb-3 text-center"><a class="nav-link text-danger fw-bold bg-light" onclick="window.logout()" style="border: 1px solid #fee2e2;"><i class="fas fa-sign-out-alt"></i> ÇIKIŞ YAP</a></div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            
            <div id="tab-main" class="tab-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h3 class="fw-bold text-dark mb-0">Genel Bakış</h3><p class="text-muted small mb-0">Yemekhane aktivite özeti.</p></div>
                    <div class="bg-white px-4 py-2 rounded-pill shadow-sm fw-bold text-primary border d-flex align-items-center"><i class="far fa-calendar-alt me-2"></i><span id="bugunTarih"></span></div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-6 col-xl-3"><div class="admin-card stat-card-new"><div class="stat-info"><h6>Toplam Mevcut</h6><h3 id="lblToplamOgrenci">0</h3></div><div class="stat-icon-box bg-light text-primary"><i class="fas fa-users"></i></div></div></div>
                    <div class="col-6 col-xl-3"><div class="admin-card stat-card-new"><div class="stat-info"><h6 class="text-success">Bugün Yiyen</h6><h3 id="lblBugunYiyen" class="text-success">0</h3></div><div class="stat-icon-box" style="background:#d1fae5; color:#065f46;"><i class="fas fa-utensils"></i></div></div></div>
                    <div class="col-6 col-xl-3"><div class="admin-card stat-card-new"><div class="stat-info"><h6 class="text-warning">Henüz Yemeyen</h6><h3 id="lblYemeyen" class="text-warning">0</h3></div><div class="stat-icon-box" style="background:#fef3c7; color:#b45309;"><i class="fas fa-hourglass-half"></i></div></div></div>
                    <div class="col-6 col-xl-3"><div class="admin-card stat-card-new"><div class="stat-info"><h6 class="text-danger">Mükerrer Geçiş</h6><h3 id="lblCiftDikis" class="text-danger">0</h3></div><div class="stat-icon-box" style="background:#fee2e2; color:#991b1b;"><i class="fas fa-exclamation-triangle"></i></div></div></div>
                </div>
                <div class="row g-3">
                    <div class="col-lg-7 col-xl-8"><div class="admin-card" style="min-height: 500px; display: flex; flex-direction: column;"><div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom"><h5 class="fw-bold m-0 text-dark"><i class="fas fa-stream me-2 text-primary"></i>Anlık Yemek Akışı</h5><span class="badge bg-success">Canlı</span></div><div id="akisListesi" style="overflow-y: auto; flex: 1; padding-right: 5px;"></div></div></div>
                    <div class="col-lg-5 col-xl-4"><div class="row g-3 h-100"><div class="col-12"><div class="admin-card d-flex align-items-center justify-content-center flex-column" style="min-height: 200px;"><h6 class="fw-bold text-muted mb-3 w-100 text-center">Katılım Oranı</h6><div style="height: 150px; width: 100%; display:flex; justify-content:center;"><canvas id="yemekPieChart"></canvas></div></div></div><div class="col-12" style="flex: 1;"><div class="admin-card" style="display: flex; flex-direction: column; height: 100%; min-height: 300px;"><div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom"><div class="d-flex align-items-center"><h6 class="fw-bold m-0 text-dark me-2">Henüz Yemeyenler</h6><span class="badge bg-secondary" id="lblBekleyenSayiKucuk">0</span></div><div><button class="sort-btn active" id="btnSortAd" onclick="changeSort('ad_soyad')">Ad</button><button class="sort-btn" id="btnSortSinif" onclick="changeSort('sinif')">Sınıf</button><button class="sort-btn" id="btnSortNo" onclick="changeSort('numara')">No</button></div></div><div id="yemeyenlerListesi" style="overflow-y: auto; flex: 1;"><div class="text-center text-muted small py-3">Yükleniyor...</div></div></div></div></div></div>
                </div>
            </div>

            <div id="tab-students" class="tab-content d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h3 class="fw-bold text-dark mb-0">Öğrenci Yönetimi</h3><p class="text-muted small mb-0">Öğrenci kayıt işlemleri.</p></div>
                    <div class="d-flex gap-2">
                        <button onclick="openBulkPhotoModal()" class="btn btn-info text-white fw-bold"><i class="fas fa-images me-1"></i> Toplu Foto</button>
                        <button onclick="openStudentModal('add')" class="btn btn-primary"><i class="fas fa-plus me-1"></i> Yeni</button>
                        <button onclick="bulkDelete()" class="btn btn-danger"><i class="fas fa-trash-alt me-1"></i> Sil</button>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="row mb-4 g-2"><div class="col-12 col-md-8"><div class="input-group"><span class="input-group-text bg-light border-end-0 text-muted"><i class="fas fa-search"></i></span><input type="text" id="studentSearch" class="form-control border-start-0 ps-0" placeholder="İsim, Numara veya Sınıf Ara..." onkeyup="filterStudents()"></div></div><div class="col-12 col-md-4"><input type="file" id="excelDosyasi" class="form-control" accept=".xlsx" onchange="excelYukle()"></div></div>
                    <div class="table-responsive"><table class="table table-hover"><thead><tr><th width="40"><input type="checkbox" id="selectAll" class="form-check-input" onclick="toggleSelectAll()"></th><th class="sortable-th" onclick="sortStudents('numara')">No</th><th class="sortable-th" onclick="sortStudents('ad_soyad')">Ad Soyad</th><th class="sortable-th" onclick="sortStudents('sinif')">Sınıf</th><th>Barkod</th><th>İşlem</th></tr></thead><tbody id="studentListBody"></tbody></table></div>
                </div>
            </div>

            <div id="tab-cards" class="tab-content d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h3 class="fw-bold text-dark mb-0">Yemek Kartı Basımı</h3><p class="text-muted small mb-0">Öğrenci seçimi ve kart yazdırma.</p></div>
                    <div class="d-flex gap-2">
                        <button onclick="openTemplateSettings()" class="btn btn-warning text-white fw-bold"><i class="fas fa-cog me-2"></i>Tasarım Ayarla</button>
                        <button onclick="printCards('front')" class="btn btn-success fw-bold"><i class="fas fa-print me-2"></i>Ön Yüz</button>
                        <button onclick="printCards('back')" class="btn btn-secondary fw-bold"><i class="fas fa-undo me-2"></i>Arka Yüz</button>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="alert alert-info border-0 mb-0 py-2"><i class="fas fa-info-circle me-2"></i>A4 sayfasına 8 kart (2x4) sığdırılır.</div>
                        <div class="bg-light p-2 rounded border">
                            <small class="fw-bold text-muted me-2">SIRALAMA:</small>
                            <button class="sort-btn active" id="btnCardSortAd" onclick="changeCardSort('ad_soyad')">İsim</button>
                            <button class="sort-btn" id="btnCardSortSinif" onclick="changeCardSort('sinif')">Sınıf</button>
                            <button class="sort-btn" id="btnCardSortNo" onclick="changeCardSort('numara')">Numara</button>
                        </div>
                    </div>
                    <div class="input-group mb-3"><span class="input-group-text bg-light border-end-0 text-muted"><i class="fas fa-search"></i></span><input type="text" id="cardSearch" class="form-control border-start-0 ps-0" placeholder="Öğrenci Ara..." onkeyup="filterCardTable()"></div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y:auto;">
                        <table class="table table-hover">
                            <thead><tr><th width="40"><input type="checkbox" id="selectAllCards" class="form-check-input" onclick="toggleSelectAllCards()"></th><th>No</th><th>Ad Soyad</th><th>Sınıf</th><th>Barkod</th></tr></thead>
                            <tbody id="cardListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-codes" class="tab-content d-none"><div class="d-flex justify-content-between align-items-center mb-4"><h3 class="fw-bold text-dark">Veli Erişim Kodları</h3></div><div class="admin-card mb-4"><div class="d-flex flex-wrap gap-2 mb-3"><button onclick="generateMissingCodes()" class="btn btn-primary btn-sm">Eksikleri Tamamla</button><button onclick="regenerateAllCodes()" class="btn btn-warning btn-sm text-white">Tümünü Yenile</button><button onclick="deleteAllCodes()" class="btn btn-danger btn-sm">Tümünü Sil</button><button onclick="printCodes()" class="btn btn-secondary btn-sm ms-auto d-md-block"><i class="fas fa-print me-1"></i> Yazdır (3x5)</button></div><div class="input-group"><span class="input-group-text bg-light border-end-0 text-muted"><i class="fas fa-search"></i></span><input type="text" id="codeSearch" class="form-control border-start-0 ps-0" placeholder="Öğrenci Ara..." onkeyup="filterCodes()"></div></div><div class="admin-card" id="code-list" style="max-height: 600px; overflow-y: auto;"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>No</th><th>Öğrenci</th><th>Kod</th><th>Durum</th><th>İşlem</th></tr></thead><tbody id="codeListBody"></tbody></table></div></div></div>
            
            <div id="tab-reports" class="tab-content d-none">
                <div class="d-flex justify-content-between align-items-center mb-4"><div><h3 class="fw-bold text-dark mb-0">Raporlar</h3><p class="text-muted small mb-0">Tarih bazlı raporlama.</p></div><button onclick="downloadExcel()" class="btn btn-success fw-bold"><i class="fas fa-file-excel me-2"></i>Excel İndir</button></div>
                <div class="admin-card mb-4"><div class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label fw-bold small text-muted">Başlangıç Tarihi</label><input type="date" id="reportStartDate" class="form-control"></div><div class="col-md-4"><label class="form-label fw-bold small text-muted">Bitiş Tarihi</label><input type="date" id="reportEndDate" class="form-control"></div><div class="col-md-4"><button onclick="queryReports()" class="btn btn-primary w-100"><i class="fas fa-search me-2"></i>Sorgula</button></div></div></div>
                <div class="admin-card">
                    <div class="alert alert-info border-0 d-flex align-items-center" id="reportSummary"><i class="fas fa-info-circle me-3 fs-4"></i><div><strong>Rapor Özeti:</strong> <span id="reportTotalCount">0</span> kayıt bulundu.</div></div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover table-bordered">
                            <thead class="table-light position-sticky top-0">
                                <tr>
                                    <th class="sortable-th" onclick="sortReport('Tarih')">Tarih <i class="fas fa-sort ms-1 small"></i></th>
                                    <th class="sortable-th" onclick="sortReport('Saat')">Saat <i class="fas fa-sort ms-1 small"></i></th>
                                    <th class="sortable-th" onclick="sortReport('Öğrenci No')">Öğrenci No <i class="fas fa-sort ms-1 small"></i></th>
                                    <th class="sortable-th" onclick="sortReport('Ad Soyad')">Ad Soyad <i class="fas fa-sort ms-1 small"></i></th>
                                    <th class="sortable-th" onclick="sortReport('Yemek Hakkı')">İşlem Türü <i class="fas fa-sort ms-1 small"></i></th>
                                    <th class="sortable-th" onclick="sortReport('İşlemi Yapan')">İşlemi Yapan <i class="fas fa-sort ms-1 small"></i></th>
                                </tr>
                            </thead>
                            <tbody id="reportListBody"><tr><td colspan="6" class="text-center text-muted py-4">Lütfen tarih aralığı seçip sorgulayınız.</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="tab-users" class="tab-content d-none"><div class="d-flex justify-content-between align-items-center mb-4"><h3 class="fw-bold text-dark">Personel Yönetimi</h3><button onclick="openScannerModal('add')" class="btn btn-primary"><i class="fas fa-user-plus me-1"></i> Yeni Personel</button></div><div class="row"><div class="col-12 col-md-8"><div class="admin-card"><h5 class="fw-bold mb-3 text-primary">Aktif Personel Listesi</h5><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>İsim</th><th>E-Posta</th><th>Rol</th><th>İşlem</th></tr></thead><tbody id="scannerListBody"></tbody></table></div></div></div><div class="col-12 col-md-4"><div class="admin-card border-warning" style="border-left: 5px solid var(--warning);"><h5 class="fw-bold text-warning mb-3">Yönetici Güvenliği</h5><div class="alert alert-warning small mb-3 border-0"><i class="fas fa-lock me-1"></i> Yönetici şifrenizi buradan değiştirebilirsiniz.</div><label class="form-label fw-bold small text-muted">Yeni Şifre</label><input type="text" id="newAdminPass" class="form-control mb-3" placeholder="En az 6 karakter"><button onclick="changeAdminPass()" class="btn btn-warning w-100 text-white fw-bold">Şifreyi Güncelle</button></div></div></div></div>
        </main>
    </div>
</div>

<div id="printArea"></div>

<div class="offcanvas offcanvas-start bg-white" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
    <div class="offcanvas-header border-bottom"><h5 class="offcanvas-title fw-bold text-dark">YÖNETİM MENÜSÜ</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body p-3">
        <ul class="nav flex-column gap-2">
            <li class="nav-item"><a class="nav-link active" onclick="showTab('main', this)"><i class="fas fa-chart-line"></i> Genel Bakış</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('students', this); loadStudents();"><i class="fas fa-user-graduate"></i> Öğrenci İşlemleri</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('codes', this); loadVeliCodes();"><i class="fas fa-qrcode"></i> Erişim Kodları</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('cards', this); loadCardPrinting();"><i class="fas fa-id-card"></i> Kart Basım</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('reports', this)"><i class="fas fa-file-excel"></i> Raporlar</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('users', this); listScannerUsers();"><i class="fas fa-users-cog"></i> Personel Yönetimi</a></li>
        </ul>
        <div class="pt-5 mt-auto"><a class="nav-link text-danger fw-bold bg-light" onclick="window.logout()" style="border: 1px solid #fee2e2;"><i class="fas fa-sign-out-alt"></i> ÇIKIŞ YAP</a></div>
    </div>
</div>

<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold" id="modalTitle">Öğrenci İşlemi</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <input type="hidden" id="editOldBarkod">
                <div class="photo-upload-container" onclick="document.getElementById('editFotoInput').click()" id="photoContainer">
                    <img id="previewFoto" src="" alt="Öğrenci">
                    <div class="upload-placeholder" id="uploadPlaceholder"><i class="fas fa-camera"></i><span>Fotoğraf Ekle</span></div>
                </div>
                <input type="file" id="editFotoInput" accept="image/*" onchange="previewImage(this)">
                <div class="mb-3"><label class="form-label fw-bold small text-muted">Ad Soyad</label><input type="text" id="editAd" class="form-control"></div>
                <div class="row g-2 mb-3"><div class="col-6"><label class="form-label fw-bold small text-muted">Numara</label><input type="text" id="editNo" class="form-control"></div><div class="col-6"><label class="form-label fw-bold small text-muted">Sınıf</label><input type="text" id="editSinif" class="form-control"></div></div>
                <div class="mb-3"><label class="form-label fw-bold small text-muted">Barkod</label><input type="text" id="editBarkodInput" class="form-control" placeholder="Otomatik Üret"></div>
            </div>
            <div class="modal-footer bg-light"><button onclick="saveStudent()" class="btn btn-primary w-100">Kaydet</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkPhotoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white"><h5 class="modal-title fw-bold">Toplu Fotoğraf Yükleme</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <div class="alert alert-info small border-0"><i class="fas fa-info-circle me-2"></i>Fotoğraf dosya isimleri öğrenci numarası olmalıdır (örn: <strong>101.jpg</strong>). Sistem numarayı bulup eşleştirecektir.</div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">Fotoğrafları Seçiniz</label>
                    <input type="file" id="bulkPhotoInput" class="form-control" multiple accept="image/*">
                </div>
                <div id="bulkUploadLog"></div>
            </div>
            <div class="modal-footer bg-light"><button onclick="uploadBulkPhotos()" class="btn btn-info text-white fw-bold w-100">Yüklemeyi Başlat</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-white"><h5 class="modal-title fw-bold">Kart Tasarım Ayarları</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <div class="alert alert-light border small">Lütfen bilgisayarınızdaki (Ön Yüz) ve (Arka Yüz) dosyalarını seçiniz. Dosyalar jpg formatında ve kredi kartı boyutunda (86mmx54mm) olmalıdır.</div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">Ön Yüz Şablonu Yükle</label>
                    <input type="file" id="tmplFront" class="form-control" accept="image/*">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">Arka Yüz Şablonu Yükle</label>
                    <input type="file" id="tmplBack" class="form-control" accept="image/*">
                </div>
            </div>
            <div class="modal-footer bg-light"><button onclick="saveTemplates()" class="btn btn-warning w-100 text-white fw-bold">Ayarları Kaydet</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="scannerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-success text-white"><h5 class="modal-title fw-bold" id="scannerModalTitle">Personel İşlemi</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><input type="hidden" id="editScannerId"><div class="mb-3"><label class="form-label fw-bold small text-muted">Görevli İsmi</label><input type="text" id="scName" class="form-control"></div><div class="mb-3"><label class="form-label fw-bold small text-muted">E-Posta</label><input type="email" id="scEmail" class="form-control"></div><div class="mb-3" id="passContainer"><label class="form-label fw-bold small text-muted">Şifre</label><input type="text" id="scPass" class="form-control"></div><div id="editStaffWarning" class="alert alert-warning small border-0 d-none"><i class="fas fa-shield-alt me-2"></i>Güvenlik gereği; şifreyi ve/veya e-postayı değiştirmek için kaydı silip yeniden oluşturunuz.</div></div><div class="modal-footer bg-light"><button onclick="saveScannerUser()" class="btn btn-success w-100">Kaydet</button></div></div></div></div>
<div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-warning text-white"><h5 class="modal-title fw-bold">Son 10 Günlük Geçmiş</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="p-3 bg-light border-bottom"><h5 id="histName" class="m-0 fw-bold text-dark"></h5></div><ul id="historyList" class="list-group list-group-flush" style="max-height:300px;overflow-y:auto;"></ul></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, updatePassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, getDoc, getDocs, orderBy, deleteDoc, limit, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyC2ATSLTN8ba3pao1kKd2cT1vHcT8rafT8", authDomain: "yemekhane-8914d.firebaseapp.com", projectId: "yemekhane-8914d", storageBucket: "yemekhane-8914d.firebasestorage.app", messagingSenderId: "352053991912", appId: "1:352053991912:web:f4ea149d68f16ae5d8ec5d" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
    
    const getTurkiyeDate = () => { const d = new Date(); return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; };
    let allStudents = [], allCodes = [], eatenTodaySet = new Set();
    let currentReportData = []; 
    let sortDir = 1;
    let notEatenSortKey = 'ad_soyad';
    let cardSortKey = 'ad_soyad';
    let reportSortDir = 1;

    window.login = async () => { try { await setPersistence(auth, browserLocalPersistence); const uc = await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); const uDoc = await getDoc(doc(db,"users",uc.user.uid)); if(!uDoc.exists() || uDoc.data().role !== "admin") { await signOut(auth); throw new Error("Yetkisiz!"); } } catch(e){Swal.fire("Hata",e.message,"error");} };
    window.logout = () => signOut(auth).then(()=>location.reload());
    onAuthStateChanged(auth, async user => { if(user) { const uDoc = await getDoc(doc(db,"users",user.uid)); if(uDoc.exists() && uDoc.data().role === "admin") { document.getElementById("loginSection").classList.add("d-none"); document.getElementById("dashboardSection").classList.remove("d-none"); startSystem(); document.getElementById("reportStartDate").value = getTurkiyeDate(); document.getElementById("reportEndDate").value = getTurkiyeDate(); } else { await signOut(auth); } } });

    function startSystem() {
        document.getElementById("bugunTarih").innerText = getTurkiyeDate();
        loadStudents(); 
        const bugunStr = getTurkiyeDate();
        const qToday = query(collection(db, "yemek_hareketleri"), where("tarih", "==", bugunStr));
        onSnapshot(qToday, snap => {
            const listDiv = document.getElementById("akisListesi"); listDiv.innerHTML="";
            let doubleCount=0; eatenTodaySet.clear(); let groupedData = {}; 
            if(snap.empty) { listDiv.innerHTML = '<div class="text-center text-muted mt-5"><i class="fas fa-coffee fa-3x mb-3"></i><p>Henüz yemek hareketi yok.</p></div>'; }
            snap.forEach(d => { const data = d.data(); data.id = d.id; eatenTodaySet.add(data.barkod); if(data.tur === 'ikinci_ogun') doubleCount++; if(!groupedData[data.barkod]) groupedData[data.barkod] = { ...data, meals: [] }; groupedData[data.barkod].meals.push(data); });
            const sortedStudents = Object.values(groupedData).sort((a,b) => { const lastTimeA = Math.max(...a.meals.map(m => m.zaman.seconds)); const lastTimeB = Math.max(...b.meals.map(m => m.zaman.seconds)); return lastTimeB - lastTimeA; });
            sortedStudents.forEach(st => {
                st.meals.sort((a,b) => a.zaman.seconds - b.zaman.seconds);
                let badges = ""; st.meals.forEach((m, idx) => { const saat = new Date(m.zaman.seconds*1000).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}); const isFirst = (idx === 0); const label = isFirst ? 'Giriş' : (idx + 1) + '. Hak'; const cls = isFirst ? 'badge-soft-success' : 'badge-soft-danger'; 
                // GÜVENLİ SİLME BUTONU
                badges += `<span class="badge ${cls} ms-1 position-relative pe-3">${label} <small class="opacity-75">${saat}</small><span class="delete-btn-wrapper" onclick="window.deleteMeal(event, '${m.id}')" title="Kaydı Sil"><i class="fas fa-times-circle text-danger"></i></span></span>`; });
                const initials = st.ad_soyad ? st.ad_soyad.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() : "??";
                listDiv.innerHTML += `<div class="feed-row" onclick="showHistory('${st.barkod}', '${st.ad_soyad}')"><div class="d-flex align-items-center"><div class="feed-avatar">${initials}</div><div><div class="fw-bold text-dark">${st.ad_soyad}</div><div class="small text-muted">${st.ogrenci_no || '-'} &bull; ${st.islem_yapan_isim || 'Sistem'}</div></div></div><div class="text-end">${badges}</div></div>`;
            });
            document.getElementById("lblCiftDikis").innerText = doubleCount; document.getElementById("lblBugunYiyen").innerText = eatenTodaySet.size; updateStats();
        });
    }

    window.changeSort = (key) => {
        notEatenSortKey = key;
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        if(key==='ad_soyad') document.getElementById('btnSortAd').classList.add('active');
        if(key==='sinif') document.getElementById('btnSortSinif').classList.add('active');
        if(key==='numara') document.getElementById('btnSortNo').classList.add('active');
        updateStats();
    };

    function updateStats() {
        if(allStudents.length === 0) return;
        document.getElementById("lblToplamOgrenci").innerText = allStudents.length;
        let eatenStudentCount = 0; allStudents.forEach(s => { if(eatenTodaySet.has(s.barkod)) eatenStudentCount++; });
        const notEaten = Math.max(0, allStudents.length - eatenStudentCount); 
        document.getElementById("lblYemeyen").innerText = notEaten; 
        document.getElementById("lblBekleyenSayiKucuk").innerText = notEaten; 
        const yemeyenlerDiv = document.getElementById("yemeyenlerListesi"); yemeyenlerDiv.innerHTML = "";
        const yemeyenler = allStudents.filter(s => !eatenTodaySet.has(s.barkod));
        yemeyenler.sort((a, b) => { let valA = a[notEatenSortKey] ? a[notEatenSortKey].toString() : ""; let valB = b[notEatenSortKey] ? b[notEatenSortKey].toString() : ""; if (notEatenSortKey === 'numara' && !isNaN(valA) && !isNaN(valB)) { return parseInt(valA) - parseInt(valB); } return valA.localeCompare(valB, 'tr', { numeric: true }); });
        if(yemeyenler.length === 0) { yemeyenlerDiv.innerHTML = "<div class='text-center text-success py-3 fw-bold'>Herkes yemek yedi! <i class='fas fa-check-circle'></i></div>"; } 
        else { yemeyenler.forEach(s => { yemeyenlerDiv.innerHTML += `<div style="padding: 8px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;"><div><span class="text-primary fw-bold me-2" style="font-size:0.8rem;">${s.numara || '-'}</span><span class="text-dark small fw-bold">${s.ad_soyad}</span></div><span class="badge bg-light text-secondary border small">${s.sinif}</span></div>`; }); }
        const ctx = document.getElementById('yemekPieChart').getContext('2d'); if(window.myPie) window.myPie.destroy(); window.myPie = new Chart(ctx, { type: 'doughnut', data: { labels: ['Yiyen', 'Bekleyen'], datasets: [{ data: [eatenStudentCount, notEaten], backgroundColor: ['#10b981', '#fef3c7'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10, font: {size: 10} } } }, cutout: '70%' } });
    }

    // --- ÖĞRENCİ YÖNETİMİ ---
    window.loadStudents = async () => { const s = await getDocs(collection(db,"ogrenciler")); allStudents = []; s.forEach(d=>allStudents.push(d.data())); filterStudents(); updateStats(); loadCardPrinting(); };
    window.filterStudents = () => { const v = document.getElementById("studentSearch").value.toLowerCase(); const tb = document.getElementById("studentListBody"); tb.innerHTML = ""; const f = allStudents.filter(s => (s.ad_soyad+s.numara+s.sinif+s.barkod).toLowerCase().includes(v)); f.slice(0, 100).forEach(s => { tb.innerHTML += `<tr><td><input type="checkbox" class="st-check form-check-input" value="${s.barkod}"></td><td>${s.numara}</td><td class="fw-bold text-primary">${s.ad_soyad}</td><td><span class="badge bg-light text-dark border">${s.sinif}</span></td><td class="text-muted small font-monospace">${s.barkod}</td><td><button onclick="openStudentModal('edit', '${s.barkod}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button> <button onclick="deleteStudent('${s.barkod}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`; }); };
    window.sortStudents = (key) => { sortDir *= -1; allStudents.sort((a, b) => { let valA = a[key] ? a[key].toString() : ""; let valB = b[key] ? b[key].toString() : ""; if (key === 'numara' && !isNaN(valA) && !isNaN(valB)) { return (parseInt(valA) - parseInt(valB)) * sortDir; } return valA.localeCompare(valB, 'tr', { numeric: true }) * sortDir; }); filterStudents(); };
    
    // -- FOTOĞRAF İŞLEMLERİ (TEKLİ) --
    window.previewImage = (input) => { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('previewFoto').src = e.target.result; document.getElementById('photoContainer').classList.add('has-img'); }; reader.readAsDataURL(input.files[0]); } };
    window.openStudentModal = (mode, barkod = null) => { const t = document.getElementById("modalTitle"), i = document.getElementById("editBarkodInput"); document.getElementById("editAd").value = ""; document.getElementById("editNo").value = ""; document.getElementById("editSinif").value = ""; document.getElementById("editOldBarkod").value = ""; i.value = ""; document.getElementById("previewFoto").src = ""; document.getElementById("photoContainer").classList.remove("has-img"); document.getElementById("editFotoInput").value = ""; if(mode === 'add') { t.innerText = "Öğrenci Ekle"; i.placeholder = "Boş bırakılırsa otomatik üretilir"; } else { t.innerText = "Öğrenci Düzenle"; const s = allStudents.find(x => x.barkod === barkod); if(s) { document.getElementById("editAd").value = s.ad_soyad; document.getElementById("editNo").value = s.numara; document.getElementById("editSinif").value = s.sinif; document.getElementById("editOldBarkod").value = s.barkod; i.value = s.barkod; if(s.foto && s.foto.length > 10) { document.getElementById("previewFoto").src = s.foto; document.getElementById("photoContainer").classList.add("has-img"); } } } new bootstrap.Modal(document.getElementById('studentModal')).show(); };
    const resizeImage = (base64Str, maxWidth = 300, maxHeight = 400) => { return new Promise((resolve) => { let img = new Image(); img.src = base64Str; img.onload = () => { let canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } } canvas.width = width; canvas.height = height; let ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.8)); }; }); };
    
    // -- TOPLU FOTOĞRAF YÜKLEME --
    window.openBulkPhotoModal = () => { document.getElementById("bulkUploadLog").innerHTML = "Hazır..."; document.getElementById("bulkPhotoInput").value = ""; new bootstrap.Modal(document.getElementById('bulkPhotoModal')).show(); };
    window.uploadBulkPhotos = async () => {
        const input = document.getElementById("bulkPhotoInput");
        const log = document.getElementById("bulkUploadLog");
        if(input.files.length === 0) return Swal.fire("Uyarı", "Lütfen fotoğraf seçiniz", "warning");
        log.innerHTML = "İşlem başlıyor...<br>";
        let successCount = 0;
        for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            const fileName = file.name.split('.')[0];
            const student = allStudents.find(s => s.numara === fileName);
            if (student) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => reader.onload = () => resolve());
                const resizedPhoto = await resizeImage(reader.result);
                try {
                    await setDoc(doc(db, "ogrenciler", student.barkod), { foto: resizedPhoto }, { merge: true });
                    log.innerHTML += `<span class="text-success">✔ ${fileName} - ${student.ad_soyad} yüklendi.</span><br>`;
                    successCount++;
                } catch(e) { log.innerHTML += `<span class="text-danger">✖ ${fileName} hata: ${e.message}</span><br>`; }
            } else { log.innerHTML += `<span class="text-warning">⚠ ${fileName} numaralı öğrenci bulunamadı.</span><br>`; }
            log.scrollTop = log.scrollHeight;
        }
        log.innerHTML += `<br><strong>BİTTİ! Toplam ${successCount} fotoğraf güncellendi.</strong>`;
        await loadStudents();
    };

    window.saveStudent = async () => { const o = document.getElementById("editOldBarkod").value, nA = document.getElementById("editAd").value, nN = document.getElementById("editNo").value, nS = document.getElementById("editSinif").value; let nB = document.getElementById("editBarkodInput").value.trim(); if(!nA) return Swal.fire("Hata", "İsim giriniz", "warning"); if(!nB) nB = o ? o : Date.now().toString(); Swal.showLoading(); let photoData = ""; const fileInput = document.getElementById("editFotoInput"); const existingImg = document.getElementById("previewFoto").src; if (fileInput.files.length > 0) { const reader = new FileReader(); reader.readAsDataURL(fileInput.files[0]); await new Promise(resolve => reader.onload = () => resolve()); photoData = await resizeImage(reader.result); } else if (existingImg && existingImg.startsWith("data:image")) { photoData = existingImg; } try { if(o && o !== nB) await deleteDoc(doc(db, "ogrenciler", o)); await setDoc(doc(db, "ogrenciler", nB), { barkod: nB, ad_soyad: nA, numara: nN, sinif: nS, foto: photoData }, {merge:true}); bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide(); await loadStudents(); Swal.fire("Başarılı", "Kayıt tamam.", "success"); } catch(e) { Swal.fire("Hata", e.message, "error"); } };
    window.deleteStudent = async (b) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db,"ogrenciler",b)); loadStudents(); } };
    window.toggleSelectAll = () => { document.querySelectorAll('.st-check').forEach(c => c.checked = document.getElementById("selectAll").checked); };
    window.bulkDelete = async () => { const c = document.querySelectorAll('.st-check:checked'); if(c.length === 0) return Swal.fire("Seçim Yapın", "", "warning"); if(!confirm(`${c.length} kayıt silinecek?`)) return; for(const x of c) await deleteDoc(doc(db, "ogrenciler", x.value)); loadStudents(); Swal.fire("Silindi", "", "success"); };

    // --- KART BASIM İŞLEMLERİ ---
    window.loadCardPrinting = () => { filterCardTable(); };
    window.changeCardSort = (key) => {
        cardSortKey = key;
        document.getElementById('btnCardSortAd').classList.remove('active'); document.getElementById('btnCardSortSinif').classList.remove('active'); document.getElementById('btnCardSortNo').classList.remove('active');
        if(key==='ad_soyad') document.getElementById('btnCardSortAd').classList.add('active'); if(key==='sinif') document.getElementById('btnCardSortSinif').classList.add('active'); if(key==='numara') document.getElementById('btnCardSortNo').classList.add('active');
        filterCardTable();
    };
    window.filterCardTable = () => {
        const v = document.getElementById("cardSearch").value.toLowerCase(); const tb = document.getElementById("cardListBody"); tb.innerHTML = "";
        let f = allStudents.filter(s => (s.ad_soyad+s.numara+s.sinif+s.barkod).toLowerCase().includes(v));
        f.sort((a, b) => { let valA = a[cardSortKey] ? a[cardSortKey].toString() : ""; let valB = b[cardSortKey] ? b[cardSortKey].toString() : ""; if (cardSortKey === 'numara' && !isNaN(valA) && !isNaN(valB)) { return parseInt(valA) - parseInt(valB); } return valA.localeCompare(valB, 'tr', { numeric: true }); });
        f.forEach(s => { tb.innerHTML += `<tr><td><input type="checkbox" class="card-check form-check-input" value="${s.barkod}"></td><td>${s.numara}</td><td>${s.ad_soyad}</td><td>${s.sinif}</td><td class="small text-muted">${s.barkod}</td></tr>`; });
    };
    window.toggleSelectAllCards = () => { const checked = document.getElementById("selectAllCards").checked; document.querySelectorAll('.card-check').forEach(c => c.checked = checked); };

    // -- Şablon Ayarları --
    window.openTemplateSettings = () => { new bootstrap.Modal(document.getElementById('templateModal')).show(); };
    window.saveTemplates = async () => {
        const f = document.getElementById('tmplFront').files[0];
        const b = document.getElementById('tmplBack').files[0];
        if(!f && !b) return Swal.fire("Uyarı", "En az bir dosya seçiniz.", "warning");
        const readBase64 = (file) => new Promise((resolve) => { const r = new FileReader(); r.onload = (e) => resolve(e.target.result); r.readAsDataURL(file); });
        try {
            if(f) localStorage.setItem('cardFront', await readBase64(f));
            if(b) localStorage.setItem('cardBack', await readBase64(b));
            bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
            Swal.fire("Tamam", "Şablonlar tarayıcıya kaydedildi.", "success");
        } catch(e) { Swal.fire("Hata", e.message, "error"); }
    };

    window.printCards = (side) => {
        const checkboxes = document.querySelectorAll('.card-check:checked');
        if(checkboxes.length === 0) return Swal.fire("Seçim Yapın", "Lütfen yazdırılacak öğrencileri seçiniz.", "warning");
        const printArea = document.getElementById("printArea"); printArea.innerHTML = "";
        
        let bgImg = side === 'front' ? localStorage.getItem('cardFront') : localStorage.getItem('cardBack');
        if(!bgImg) { bgImg = side === 'front' ? '2.jpg' : '3.jpg'; } 

        let selectedStudents = [];
        checkboxes.forEach(cb => { const st = allStudents.find(s => s.barkod === cb.value); if(st) selectedStudents.push(st); });
        selectedStudents.sort((a, b) => { let valA = a[cardSortKey] ? a[cardSortKey].toString() : ""; let valB = b[cardSortKey] ? b[cardSortKey].toString() : ""; if (cardSortKey === 'numara' && !isNaN(valA) && !isNaN(valB)) { return parseInt(valA) - parseInt(valB); } return valA.localeCompare(valB, 'tr', { numeric: true }); });

        const cardsPerPage = 8; 
        for (let i = 0; i < selectedStudents.length; i += cardsPerPage) {
            const pageStudents = selectedStudents.slice(i, i + cardsPerPage);
            const pageDiv = document.createElement("div"); pageDiv.className = "print-page cards";
            pageStudents.forEach(st => {
                const cardContainer = document.createElement("div"); cardContainer.className = "meal-card-container";
                cardContainer.style.backgroundImage = `url('${bgImg}')`;
                if(side === 'front') {
                    const photoBox = document.createElement("div"); photoBox.className = "card-photo-box";
                    if(st.foto && st.foto.length > 50) { const img = document.createElement("img"); img.src = st.foto; img.className = "card-photo"; photoBox.appendChild(img); } 
                    else { photoBox.innerHTML = ''; } 
                    cardContainer.appendChild(photoBox);
                    const infoBox = document.createElement("div"); infoBox.className = "card-info-area";
                    infoBox.innerHTML = `<div class="info-row"><span class="info-label">Adı Soyadı</span><span class="info-sep">:</span><span class="info-val">${st.ad_soyad}</span></div><div class="info-row"><span class="info-label">Sınıfı</span><span class="info-sep">:</span><span class="info-val">${st.sinif}</span></div><div class="info-row"><span class="info-label">Numarası</span><span class="info-sep">:</span><span class="info-val">${st.numara}</span></div>`;
                    cardContainer.appendChild(infoBox);
                    const qrBox = document.createElement("div"); qrBox.id = "qr_" + st.barkod; qrBox.className = "card-qr-area"; cardContainer.appendChild(qrBox);
                } 
                pageDiv.appendChild(cardContainer);
            });
            printArea.appendChild(pageDiv);
        }
        if(side === 'front') {
            selectedStudents.forEach(st => {
                const el = document.getElementById("qr_" + st.barkod);
                if(el) { new QRCode(el, { text: st.barkod, width: 61, height: 61, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H }); }
            });
        }
        
        setTimeout(() => { 
            window.print(); 
            localStorage.removeItem('cardFront');
            localStorage.removeItem('cardBack');
        }, 500);
    };

    window.printCodes = () => {
        const printArea = document.getElementById("printArea"); printArea.innerHTML = "";
        const validCodes = allCodes.filter(c => !c.kullanildi);
        if(validCodes.length === 0) return Swal.fire("Bilgi", "Yazdırılacak kod yok.", "info");
        const codesPerPage = 15; // 3x5
        for (let i = 0; i < validCodes.length; i += codesPerPage) {
            const pageCodes = validCodes.slice(i, i + codesPerPage);
            const pageDiv = document.createElement("div"); pageDiv.className = "print-page codes";
            pageCodes.forEach(c => {
                const codeCard = document.createElement("div"); codeCard.className = "code-card-print";
                codeCard.innerHTML = `<div style="font-weight:bold; font-size:14pt;">YEMEKHANE</div><div style="font-size:10pt; margin-bottom:5px;">Veli Erişim Kodu</div><div style="font-size:24pt; font-weight:800; letter-spacing:2px; border:2px solid #000; padding:5px 15px; border-radius:10px; margin:5px 0;">${c.id}</div><div style="font-size:12pt; font-weight:600;">${c.ogrAd}</div>`;
                pageDiv.appendChild(codeCard);
            });
            printArea.appendChild(pageDiv);
        }
        setTimeout(() => { window.print(); }, 500);
    };

    window.sortReport = (key) => {
        if(key === window.lastReportSortKey) reportSortDir *= -1; else reportSortDir = 1; window.lastReportSortKey = key;
        currentReportData.sort((a, b) => {
            let valA = a[key] ? a[key].toString().toLowerCase() : ""; let valB = b[key] ? b[key].toString().toLowerCase() : "";
            if (key === 'Tarih') { return valA.localeCompare(valB) * reportSortDir; }
            if (key === 'Öğrenci No' && !isNaN(valA) && !isNaN(valB)) { return (parseInt(valA) - parseInt(valB)) * reportSortDir; }
            return valA.localeCompare(valB, 'tr', { numeric: true }) * reportSortDir;
        });
        renderReportTable();
    };

    window.renderReportTable = () => {
        const tbody = document.getElementById("reportListBody"); tbody.innerHTML = "";
        currentReportData.forEach(row => {
            const badgeColor = row['Yemek Hakkı'].includes('Giriş') || row['Yemek Hakkı'].startsWith('1.') ? 'bg-success' : 'bg-danger';
            tbody.innerHTML += `<tr><td>${row.Tarih}</td><td>${row.Saat}</td><td>${row['Öğrenci No']}</td><td class="fw-bold">${row['Ad Soyad']}</td><td><span class="badge ${badgeColor}">${row['Yemek Hakkı']}</span></td><td class="small text-muted">${row['İşlemi Yapan']}</td></tr>`;
        });
    };

    // --- SİLME İŞLEVİ İÇİN KRİTİK GÜNCELLEME ---
    // Bu fonksiyonu window objesine açıkça atadığımızdan ve HTML'de stopPropagation 
    // kullandığımızdan emin olmalıyız.
    window.deleteMeal = async (e, docId) => { 
        if(e && e.stopPropagation) e.stopPropagation(); // Satır tıklamasını engelle
        
        const result = await Swal.fire({ 
            title: 'Kayıt Silinsin mi?', 
            text: "Bu işlem geri alınamaz!", 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#ef4444', 
            cancelButtonColor: '#64748b', 
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'İptal'
        }); 
        
        if (result.isConfirmed) { 
            try { 
                await deleteDoc(doc(db, "yemek_hareketleri", docId)); 
                Swal.fire({
                    icon: 'success', 
                    title: 'Silindi', 
                    toast: true, 
                    position: 'top-end', 
                    timer: 2000, 
                    showConfirmButton: false
                }); 
            } catch (err) { 
                Swal.fire("Hata", err.message, "error"); 
            } 
        } 
    };

    // Diğer JS fonksiyonları aynı...
    window.openScannerModal = (m, u=null, n='', e='') => { document.getElementById("editScannerId").value = u||""; document.getElementById("scName").value = n; document.getElementById("scEmail").value = e; const emailField = document.getElementById("scEmail"), passContainer = document.getElementById("passContainer"), warning = document.getElementById("editStaffWarning"); if(m === 'add') { document.getElementById("scEmail").value = ""; document.getElementById("scPass").value = ""; emailField.disabled = false; passContainer.classList.remove("d-none"); warning.classList.add("d-none"); document.getElementById("scannerModalTitle").innerText = "Yeni Personel Ekle"; } else { emailField.disabled = true; passContainer.classList.add("d-none"); warning.classList.remove("d-none"); document.getElementById("scannerModalTitle").innerText = "Personel Düzenle"; } new bootstrap.Modal(document.getElementById('scannerModal')).show(); };
    window.saveScannerUser = async () => { const uid = document.getElementById("editScannerId").value, name = document.getElementById("scName").value; if(!name) return Swal.fire("Eksik", "İsim zorunludur.", "warning"); Swal.showLoading(); if (uid) { try { await updateDoc(doc(db, "users", uid), { displayName: name, role: "scanner" }); bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide(); Swal.fire("Başarılı", "Güncellendi.", "success"); listScannerUsers(); } catch (e) { Swal.fire("Hata", e.message, "error"); } } else { const email = document.getElementById("scEmail").value, pass = document.getElementById("scPass").value; if(!email || !pass) return Swal.fire("Eksik", "E-Posta ve Şifre zorunludur.", "warning"); let sa = null; try { sa = initializeApp(firebaseConfig, "ScUser"); const saAuth = getAuth(sa); const uc = await createUserWithEmailAndPassword(saAuth, email, pass); await setDoc(doc(db, "users", uc.user.uid), { email, displayName: name, role: "scanner", createdAt: new Date().toISOString() }); await signOut(saAuth); bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide(); Swal.fire("Başarılı", "Oluşturuldu.", "success"); listScannerUsers(); } catch(e) { Swal.fire("Hata", e.message, "error"); } finally { if(sa) deleteApp(sa); } } };
    window.listScannerUsers = async () => { const t = document.getElementById("scannerListBody"); const q = query(collection(db, "users"), where("role", "==", "scanner")); const s = await getDocs(q); t.innerHTML = s.empty ? "<tr><td colspan='4'>Kayıt yok</td></tr>" : ""; s.forEach(d => { const u = d.data(); t.innerHTML += `<tr><td class="fw-bold">${u.displayName||'-'}</td><td>${u.email}</td><td><span class="badge bg-info text-dark">Görevli</span></td><td><button onclick="openScannerModal('edit', '${d.id}', '${u.displayName}', '${u.email}')" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button> <button onclick="deleteScanner('${d.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`; }); };
    window.deleteScanner = async (id) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db,"users",id)); listScannerUsers(); } };
    window.changeAdminPass = async () => { const p=document.getElementById("newAdminPass").value; if(p.length<6) return Swal.fire("Hata","En az 6 karakter olmalı","warning"); try{await updatePassword(auth.currentUser,p);Swal.fire("Başarılı","Şifre güncellendi","success");document.getElementById("newAdminPass").value="";}catch(e){if(e.code==='auth/requires-recent-login'){const {value:cp}=await Swal.fire({title:'Güvenlik',text:'Mevcut şifrenizi girin:',input:'password',showCancelButton:true});if(cp){try{await reauthenticateWithCredential(auth.currentUser,EmailAuthProvider.credential(auth.currentUser.email,cp));await updatePassword(auth.currentUser,p);Swal.fire("Başarılı","Şifre güncellendi","success");}catch(z){Swal.fire("Hata","Yanlış şifre","error");}}}else{Swal.fire("Hata",e.message,"error");}}};
    window.loadVeliCodes = async () => { const s = await getDocs(collection(db, "veli_kodlari")); allCodes = []; s.forEach(d => { const c = d.data(); const student = allStudents.find(s => s.barkod == c.ogrenci_barkod); c.id = d.id; c.ogrAd = student ? student.ad_soyad : "Bilinmeyen"; c.ogrNo = student ? student.numara : "-"; allCodes.push(c); }); filterCodes(); };
    window.filterCodes = () => { const v = document.getElementById("codeSearch").value.toLowerCase(); const tb = document.getElementById("codeListBody"); tb.innerHTML = ""; allCodes.filter(c => (c.ogrAd + c.ogrNo).toLowerCase().includes(v)).forEach(c => { tb.innerHTML += `<tr><td><span class="badge bg-light text-dark border">${c.ogrNo}</span></td><td>${c.ogrAd}</td><td class="fw-bold text-primary">${c.id}</td><td>${c.kullanildi?'<span class="text-danger">Kullanıldı</span>':'Aktif'}</td><td><button onclick="deleteCode('${c.id}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button></td></tr>`; }); };
    window.generateMissingCodes = async () => { let c=0; const e = new Set(allCodes.map(x=>x.ogrenci_barkod)); for(const s of allStudents) { if(!e.has(s.barkod)) { await setDoc(doc(db,"veli_kodlari",Math.floor(100000+Math.random()*900000).toString()),{ogrenci_barkod:s.barkod, kullanildi:false}); c++; } } loadVeliCodes(); Swal.fire(`${c} kod üretildi`); };
    window.regenerateAllCodes = async () => { if(confirm("Tümü yenilenecek!")) { const s = await getDocs(collection(db,"veli_kodlari")); s.forEach(d=>deleteDoc(d.ref)); generateMissingCodes(); } };
    window.deleteAllCodes = async () => { if(confirm("Hepsi silinecek!")) { const s = await getDocs(collection(db,"veli_kodlari")); s.forEach(d=>deleteDoc(d.ref)); loadVeliCodes(); } };
    window.deleteCode = async (id) => { await deleteDoc(doc(db,"veli_kodlari",id)); loadVeliCodes(); };
    window.excelYukle = async () => { const fi = document.getElementById('excelDosyasi'); if(fi.files.length===0) return Swal.fire("Uyarı","Dosya seçiniz","warning"); Swal.showLoading(); const r = new FileReader(); r.onload = async function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type:'array'}); const j = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); let c=0; for(const ogr of j) { if(ogr.barkod && ogr.ad_soyad) { const b=String(ogr.barkod).trim(); await setDoc(doc(db,"ogrenciler",b),{barkod:b,ad_soyad:ogr.ad_soyad,sinif:ogr.sinif?String(ogr.sinif).trim():"-",numara:ogr.numara?String(ogr.numara).trim():"",foto:ogr.foto||""}); c++; } } Swal.fire("Tamam", `${c} yüklendi.`, "success"); loadStudents(); } catch(z) { Swal.fire("Hata",z.message,"error"); } }; r.readAsArrayBuffer(fi.files[0]); };
    window.showTab = (id, el) => { document.querySelectorAll('.tab-content').forEach(x=>x.classList.add('d-none')); document.getElementById('tab-'+id).classList.remove('d-none'); document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active')); if(el){el.classList.add('active');} document.querySelectorAll('.offcanvas-body .nav-link').forEach(x=>{ x.classList.remove('active'); if(x.getAttribute('onclick').includes(id)) x.classList.add('active'); }); };
    document.addEventListener('DOMContentLoaded', () => { const mobileSidebar = document.getElementById('mobileSidebar'); if (mobileSidebar) { mobileSidebar.addEventListener('hide.bs.offcanvas', () => { document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active')); const activeTab = document.querySelector('.tab-content:not(.d-none)'); if (activeTab) { const tabId = activeTab.id.replace('tab-', ''); document.querySelector(`.sidebar .nav-link[onclick*="'${tabId}'"]`)?.classList.add('active'); } }); } });
    window.queryReports = async () => { const start = document.getElementById("reportStartDate").value; const end = document.getElementById("reportEndDate").value; if(!start || !end) return Swal.fire("Uyarı", "Başlangıç ve Bitiş tarihi seçiniz.", "warning"); if(start > end) return Swal.fire("Hata", "Başlangıç tarihi bitiş tarihinden büyük olamaz.", "error"); Swal.showLoading(); try { const q = query(collection(db, "yemek_hareketleri"), where("tarih", ">=", start), where("tarih", "<=", end)); const snap = await getDocs(q); currentReportData = []; if(snap.empty) { document.getElementById("reportListBody").innerHTML = "<tr><td colspan='6' class='text-center text-danger'>Bu tarih aralığında kayıt bulunamadı.</td></tr>"; document.getElementById("reportTotalCount").innerText = "0"; Swal.close(); return; } 
        // Veriyi çek ve sırala (önce tarih/saat)
        let rawList = []; snap.forEach(d => { let data = d.data(); data._timestamp = data.zaman.seconds; rawList.push(data); });
        rawList.sort((a,b) => a._timestamp - b._timestamp);
        // Hak hesaplama
        const tracker = {}; 
        rawList.forEach(row => {
            const key = `${row.barkod}_${row.tarih}`; if(!tracker[key]) tracker[key] = 0; tracker[key]++; const rank = tracker[key];
            const jsDate = new Date(row._timestamp * 1000); const timeStr = jsDate.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
            currentReportData.push({ "Tarih": row.tarih, "Saat": timeStr, "Öğrenci No": row.ogrenci_no || "-", "Ad Soyad": row.ad_soyad, "Yemek Hakkı": rank === 1 ? "Giriş" : `${rank}. Hak`, "İşlemi Yapan": row.islem_yapan_isim || row.islem_yapan || "Sistem" });
        });
        document.getElementById("reportTotalCount").innerText = currentReportData.length; renderReportTable(); Swal.close(); 
    } catch(e) { Swal.fire("Hata", "Veri çekilirken hata oluştu: " + e.message, "error"); } };
    window.downloadExcel = () => { if(!currentReportData || currentReportData.length === 0) { return Swal.fire("Uyarı", "İndirilecek veri yok. Lütfen önce sorgulama yapınız.", "warning"); } const worksheet = XLSX.utils.json_to_sheet(currentReportData); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Rapor"); const start = document.getElementById("reportStartDate").value; const end = document.getElementById("reportEndDate").value; XLSX.writeFile(workbook, `Yemekhane_Rapor_${start}_${end}.xlsx`); };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>